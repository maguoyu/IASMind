# æ•°æ®åˆ†æç³»ç»Ÿä¼˜åŒ– - å®ç°æ¶æ„

## ğŸ“ ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      å‰ç«¯å±‚ (React)                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ChartsMain ç»„ä»¶                                         â”‚ â”‚
â”‚  â”‚ â”œâ”€ æ•°æ®æºé€‰æ‹©å™¨ (è‡ªåŠ¨é€‰æ‹©ç¬¬ä¸€ä¸ª)                        â”‚ â”‚
â”‚  â”‚ â”œâ”€ è¡¨é€‰æ‹©å™¨ (è‡ªåŠ¨åŠ è½½)                                 â”‚ â”‚
â”‚  â”‚ â”œâ”€ å›¾è¡¨æ˜¾ç¤ºå™¨                                          â”‚ â”‚
â”‚  â”‚ â””â”€ æ´å¯Ÿé¢æ¿ (å¼‚æ­¥æ›´æ–°)                                 â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ HTTP/REST API â”‚ SSE (å¯é€‰æµå¼)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    åç«¯å±‚ (FastAPI)                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ /api/data-exploration/analyze                         â”‚ â”‚
â”‚  â”‚                                                        â”‚ â”‚
â”‚  â”‚ 1. æ£€æŸ¥ç¼“å­˜ â† _llm_response_cache                     â”‚ â”‚
â”‚  â”‚ 2. è®¡ç®—æ•°æ®å“ˆå¸Œ â† _compute_data_hash()              â”‚ â”‚
â”‚  â”‚ 3. LLM è°ƒç”¨ (30s è¶…æ—¶) â† _call_llm_with_fallback() â”‚ â”‚
â”‚  â”‚ 4. ç«‹å³è¿”å›å›¾è¡¨é…ç½®                                  â”‚ â”‚
â”‚  â”‚ 5. å¼‚æ­¥ç”Ÿæˆæ´å¯Ÿ â† _async_generate_insights_and_md() â”‚ â”‚
â”‚  â”‚                                                        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ChartGenerator                                         â”‚ â”‚
â”‚  â”‚                                                        â”‚ â”‚
â”‚  â”‚ æ–¹æ³•æ ‘:                                                â”‚ â”‚
â”‚  â”‚ â”œâ”€ _generate_chart_with_llm() [æ”¹è¿›]                 â”‚ â”‚
â”‚  â”‚ â”‚  â”œâ”€ _compute_data_hash() [æ–°å¢]                   â”‚ â”‚
â”‚  â”‚ â”‚  â”œâ”€ _call_llm_with_fallback() [æ–°å¢]             â”‚ â”‚
â”‚  â”‚ â”‚  â”œâ”€ _parse_llm_response()                         â”‚ â”‚
â”‚  â”‚ â”‚  â”œâ”€ _populate_series_data_from_df()              â”‚ â”‚
â”‚  â”‚ â”‚  â””â”€ _async_generate_insights_and_md() [æ–°å¢]     â”‚ â”‚
â”‚  â”‚ â”œâ”€ _generate_chart_traditional()                    â”‚ â”‚
â”‚  â”‚ â”œâ”€ _generate_insights_from_chart()                  â”‚ â”‚
â”‚  â”‚ â””â”€ _generate_insight_markdown_from_chart()          â”‚ â”‚
â”‚  â”‚                                                        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ å…¨å±€èµ„æº                                                â”‚ â”‚
â”‚  â”‚ â”œâ”€ _llm_response_cache: Dict                          â”‚ â”‚
â”‚  â”‚ â”‚  æœ€å¤š 100 æ¡è®°å½•ï¼ŒLRU æ¸…ç†                           â”‚ â”‚
â”‚  â”‚ â””â”€ _cache_max_size: 100                              â”‚ â”‚
â”‚  â”‚                                                        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ LLM API â”‚ æ•°æ®åº“ â”‚ ç¼“å­˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              å¤–éƒ¨æœåŠ¡å±‚                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”œâ”€ OpenAI / Claude / LLM æœåŠ¡                             â”‚
â”‚  â”œâ”€ æ•°æ®åº“è¿æ¥ (MySQL, PostgreSQL, etc)                   â”‚
â”‚  â””â”€ ç¼“å­˜æœåŠ¡ (å¯é€‰çš„ Redis)                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ è¯·æ±‚å¤„ç†æµç¨‹

### å®Œæ•´æ—¶åºå›¾

```
ç”¨æˆ·           å‰ç«¯               åç«¯              LLM          ç¼“å­˜
â”‚              â”‚                  â”‚                â”‚             â”‚
â”œâ”€ç‚¹å‡»åˆ†æâ”€â”€â”€â†’ â”‚                  â”‚                â”‚             â”‚
â”‚              â”œâ”€HTTP GET        â”‚                â”‚             â”‚
â”‚              â”‚ /analyze       â”‚                â”‚             â”‚
â”‚              â”‚  (data_source, â”‚                â”‚             â”‚
â”‚              â”‚   table,       â”‚                â”‚             â”‚
â”‚              â”‚   use_llm=true)â”‚                â”‚             â”‚
â”‚              â”‚               â”‚                â”‚             â”‚
â”‚              â”‚               â”œâ”€æ£€æŸ¥ç¼“å­˜â”€â”€â”€â”€â”€â”€â†’â”‚             â”‚
â”‚              â”‚               â”‚               â”‚             â”‚
â”‚              â”‚               â”‚â—„â”€â”€ç¼“å­˜å‘½ä¸­â”€â”€(< 1s)         â”‚
â”‚              â”‚               â”‚                â”‚             â”‚
â”‚              â”‚               â”‚ è‹¥ç¼“å­˜æœªå‘½ä¸­              â”‚
â”‚              â”‚               â”œâ”€è®¡ç®—å“ˆå¸Œå€¼                â”‚
â”‚              â”‚               â”‚                â”‚             â”‚
â”‚              â”‚               â”œâ”€è°ƒç”¨ LLMâ”€â”€â”€â”€â†’â”‚             â”‚
â”‚              â”‚               â”‚              â”‚             â”‚
â”‚              â”‚â—„â”€200 Response â”‚              â”‚             â”‚
â”‚              â”‚ (spec, ...)   â”‚              â”‚             â”‚
â”‚â—„â”€æ˜¾ç¤ºå›¾è¡¨â”€â”€â”€â”¤               â”‚              â”‚             â”‚
â”‚              â”‚               â”‚              â”‚             â”‚
â”‚              â”‚               â”‚â—„â”€LLM å“åº”â”€â”€â”€â”‚             â”‚
â”‚              â”‚               â”‚ (15-20s)    â”‚             â”‚
â”‚              â”‚               â”‚                â”‚             â”‚
â”‚              â”‚               â”œâ”€å›å¡«æ•°æ®        â”‚             â”‚
â”‚              â”‚               â”‚                â”‚             â”‚
â”‚              â”‚               â”œâ”€ä¿å­˜ç¼“å­˜â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚
â”‚              â”‚               â”‚                â”‚      â””â”€ å­˜å‚¨
â”‚              â”‚               â”‚                â”‚         ï¼ˆ100æ¡ä¸Šé™ï¼‰
â”‚              â”‚               â”‚                â”‚
â”‚              â”‚               â”œâ”€å¼‚æ­¥: ç”Ÿæˆæ´å¯Ÿ
â”‚              â”‚               â”œâ”€å¼‚æ­¥: ç”Ÿæˆ Markdown
â”‚              â”‚               â”‚  (åå°å¤„ç†, ä¸é˜»å¡)
â”‚              â”‚               â”‚
â”‚              â”‚  (å¯é€‰) è½®è¯¢  â”‚
â”‚              â”œâ”€GET /statusâ”€â”€â†’â”‚
â”‚              â”‚               â”œâ”€è¿”å›æ›´æ–°çš„æ´å¯Ÿ
â”‚â—„â”€æ´å¯Ÿæ›´æ–°â”€â”€â”€â”¤â—„â”€200 Responseâ”‚
â”‚              â”‚               â”‚
```

---

## ğŸ“Š æ•°æ®æµå‘

### ç¼“å­˜æœºåˆ¶

```
è¾“å…¥æ•°æ®
   â”‚
   â”œâ”€â–º è®¡ç®— MD5 å“ˆå¸Œ
   â”‚   (shape + columns + sample + prompt[:100])
   â”‚
   â”œâ”€â–º æŸ¥è¯¢ç¼“å­˜
   â”‚   â”œâ”€ å‘½ä¸­ â”€â”€â–º è¿”å›ç¼“å­˜ç»“æœ (~1ms)
   â”‚   â””â”€ æœªå‘½ä¸­ â”€â”€â–º è°ƒç”¨ LLM (15-20s)
   â”‚
   â””â”€â–º ä¿å­˜ç»“æœåˆ°ç¼“å­˜
       (æœ€å¤š 100 æ¡, LRU ç­–ç•¥)
```

### LLM è°ƒç”¨æµç¨‹

```
è¯·æ±‚
  â”‚
  â”œâ”€â–º å‡†å¤‡æ•°æ®æ‘˜è¦
  â”‚   (shape, dtypes, sample rows)
  â”‚
  â”œâ”€â–º æ„å»ºæç¤º (Prompt)
  â”‚
  â”œâ”€â–º è°ƒç”¨ LLM with 30s timeout
  â”‚   â”œâ”€ æˆåŠŸ â”€â”€â–º è§£æå“åº”
  â”‚   â””â”€ è¶…æ—¶ â”€â”€â–º é™çº§åˆ°ä¼ ç»Ÿæ¨¡å¼
  â”‚
  â”œâ”€â–º å›å¡« Series æ•°æ®
  â”‚
  â”œâ”€â–º ç«‹å³è¿”å›ç»“æœ
  â”‚   {
  â”‚     "spec": {...},
  â”‚     "insights": [],         # åˆå§‹ä¸ºç©º
  â”‚     "insight_md": null,     # åˆå§‹ä¸º null
  â”‚     "chart_type": "bar"
  â”‚   }
  â”‚
  â””â”€â–º å¼‚æ­¥åå°å¤„ç†
      â”œâ”€ ç”Ÿæˆæ´å¯Ÿ
      â”œâ”€ ç”Ÿæˆ Markdown
      â””â”€ æ›´æ–°ç¼“å­˜ç»“æœ

```

---

## ğŸ—ï¸ æ ¸å¿ƒç±»ç»“æ„

### ChartGenerator ç±»æ”¹è¿›

```python
class ChartGenerator:
    """
    å®Œæ•´çš„æ”¹è¿›ç‚¹:
    """
    
    # å…¨å±€ç¼“å­˜ (æ¨¡å—çº§)
    _llm_response_cache = {}
    _cache_max_size = 100
    
    # ä¸»æ–¹æ³• [æ”¹è¿›]
    async def _generate_chart_with_llm(
        self, 
        df: pd.DataFrame, 
        user_prompt: str, 
        enable_insights: bool = True
    ) -> Dict[str, Any]:
        """
        ä¼˜åŒ–ç‰ˆæœ¬çš„ LLM å›¾è¡¨ç”Ÿæˆ
        
        æµç¨‹:
        1. è®¡ç®—ç¼“å­˜ Key
        2. æ£€æŸ¥ç¼“å­˜
        3. è¶…æ—¶æ§åˆ¶çš„ LLM è°ƒç”¨
        4. ç«‹å³è¿”å›ç»“æœ
        5. å¼‚æ­¥ç”Ÿæˆæ´å¯Ÿ
        
        æ€§èƒ½:
        - é¦–æ¬¡: 20-25 ç§’
        - ç¼“å­˜: <1 ç§’
        """
        ...
    
    # æ–°å¢è¾…åŠ©æ–¹æ³•
    def _compute_data_hash(
        self, 
        df: pd.DataFrame, 
        user_prompt: str
    ) -> str:
        """è®¡ç®—ç¼“å­˜ Key"""
        ...
    
    async def _call_llm_with_fallback(
        self, 
        prompt: str
    ) -> Any:
        """è°ƒç”¨ LLMï¼Œæ”¯æŒé™çº§"""
        ...
    
    async def _async_generate_insights_and_md(
        self, 
        result: Dict, 
        df: pd.DataFrame, 
        enable_insights: bool, 
        cache_key: str
    ):
        """åå°å¼‚æ­¥ç”Ÿæˆæ´å¯Ÿ"""
        ...
    
    # ç°æœ‰æ–¹æ³• (ä¿æŒä¸å˜)
    def _parse_llm_response(self, content: str) -> Dict:
        """è§£æ LLM å“åº”"""
        ...
    
    def _populate_series_data_from_df(
        self, 
        chart_spec: Dict, 
        df: pd.DataFrame
    ) -> Optional[Dict]:
        """å›å¡«æ•°æ®"""
        ...
```

---

## ğŸš€ å‰ç«¯æ”¹è¿›

### fetchSystemDataSources æ”¹è¿›

```typescript
// åŸå§‹ç‰ˆæœ¬
const fetchSystemDataSources = useCallback(async () => {
  const sources = await dataSourceApi.getAll();
  setSystemDataSources(sources);
  // ç”¨æˆ·éœ€è¦æ‰‹åŠ¨é€‰æ‹©
}, []);

// æ”¹è¿›ç‰ˆæœ¬
const fetchSystemDataSources = useCallback(async () => {
  const sources = await dataSourceApi.getAll();
  
  // è‡ªåŠ¨é€‰æ‹©ç¬¬ä¸€ä¸ª
  if (sources.length > 0) {
    const firstSource = sources[0];
    setSelectedDataSource(firstSource.id);
    
    // è‡ªåŠ¨åŠ è½½è¡¨åˆ—è¡¨
    const response = await dataSourceApi.getTables(firstSource.id);
    if (response?.success && response.tables) {
      setTablesList(response.tables);
    }
  }
  
  setSystemDataSources(sources);
}, []);
```

---

## ğŸ’¾ ç¼“å­˜è¯¦è§£

### ç¼“å­˜é”®è®¡ç®—

```python
def _compute_data_hash(df, user_prompt):
    key_components = [
        str(df.shape),              # (1000, 10) 
        ",".join(df.columns),       # col1,col2,col3
        df.head(3).to_string(),     # å‰3è¡Œæ•°æ®
        user_prompt[:100]           # æç¤ºå‰100å­—ç¬¦
    ]
    key_str = "||".join(key_components)
    return hashlib.md5(key_str.encode()).hexdigest()
    # ç»“æœ: "a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6"
```

### ç¼“å­˜å­˜å‚¨

```python
# å…¨å±€å­—å…¸
_llm_response_cache = {
    "hash_1": {
        "spec": {...},
        "insights": [...],
        "insight_md": "...",
        "chart_type": "bar"
    },
    "hash_2": {...},
    # æœ€å¤š 100 æ¡
}

# å¤§å°ç®¡ç†
if len(_llm_response_cache) >= _cache_max_size:
    oldest_key = next(iter(_llm_response_cache))
    del _llm_response_cache[oldest_key]
```

---

## â±ï¸ æ€§èƒ½æ—¶é—´çº¿

### ç¼“å­˜æœªå‘½ä¸­ï¼ˆé¦–æ¬¡åˆ†æï¼‰

```
æ—¶é—´     äº‹ä»¶
0ms   â”Œâ”€ æ¥æ”¶è¯·æ±‚
      â”‚
10ms  â”œâ”€ è®¡ç®—å“ˆå¸Œ
      â”‚
20ms  â”œâ”€ æ£€æŸ¥ç¼“å­˜ (miss)
      â”‚
50ms  â”œâ”€ å‡†å¤‡æ•°æ®æ‘˜è¦
      â”‚
100ms â”œâ”€ æ„å»ºæç¤º
      â”‚
      â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ LLM è°ƒç”¨ (15-20s) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º
      â”‚
20000msâ”œâ”€ æ¥æ”¶ LLM å“åº”
      â”‚
20100msâ”œâ”€ è§£æå“åº”
      â”‚
20150msâ”œâ”€ å›å¡«æ•°æ®
      â”‚
20200msâ”œâ”€ ä¿å­˜ç¼“å­˜
      â”‚
20250msâ””â”€ è¿”å›å“åº”ç»™å‰ç«¯
      
èƒŒæ™¯:
20250ms â”œâ”€ å¼‚æ­¥ç”Ÿæˆæ´å¯Ÿ (5-10s)
      â””â”€ å¼‚æ­¥ç”Ÿæˆ Markdown (3-5s)
```

### ç¼“å­˜å‘½ä¸­ï¼ˆé‡å¤åˆ†æï¼‰

```
æ—¶é—´    äº‹ä»¶
0ms  â”Œâ”€ æ¥æ”¶è¯·æ±‚
     â”‚
10ms â”œâ”€ è®¡ç®—å“ˆå¸Œ
     â”‚
15ms â”œâ”€ æŸ¥è¯¢ç¼“å­˜ (hit)
     â”‚
20ms â””â”€ è¿”å›ç»“æœ

æ€»è€—æ—¶: ~20ms (vs 20000ms+ çš„é¦–æ¬¡)
æ€§èƒ½æå‡: >99%
```

---

## ğŸ›¡ï¸ é”™è¯¯å¤„ç†æµç¨‹

```
â”Œâ”€â”€â”€ LLM è°ƒç”¨ â”€â”€â”€â”
â”‚                 â”‚
â”œâ”€â–º æˆåŠŸ (20s)   â”€â”€â–º è¿”å›ç»“æœ
â”‚
â”œâ”€â–º è¶…æ—¶ (30s)   â”€â”€â–º è‡ªåŠ¨é™çº§
â”‚                   â”‚
â”‚                   â”œâ”€ é™çº§åˆ°ä¼ ç»Ÿæ¨¡å¼
â”‚                   â”œâ”€ æ—  LLM è‡ªåŠ¨ç”Ÿæˆ
â”‚                   â””â”€ ç”¨æˆ·ä»èƒ½è·å¾—åŸºç¡€å›¾è¡¨
â”‚
â””â”€â–º å¼‚å¸¸         â”€â”€â–º è®°å½•é”™è¯¯
                   â”‚
                   â”œâ”€ é™çº§åˆ°ä¼ ç»Ÿæ¨¡å¼
                   â””â”€ è¿”å›åŸºç¡€ç»“æœ
```

---

## ğŸ“ˆ å¯æ‰©å±•æ€§è®¾è®¡

### æ”¯æŒå¤šç§ LLM

```python
async def _call_llm_with_fallback(prompt: str):
    llm_options = [
        ("premium", OpenAI("gpt-4")),      # æœ€å¥½
        ("standard", Claude("claude-3")),   # ä¸é”™
        ("fast", Ollama("mistral")),       # å¿«é€Ÿ
    ]
    
    for name, llm in llm_options:
        try:
            return await asyncio.wait_for(
                llm.ainvoke(prompt),
                timeout=30
            )
        except asyncio.TimeoutError:
            continue  # å°è¯•ä¸‹ä¸€ä¸ª
    
    # æ‰€æœ‰éƒ½å¤±è´¥ï¼Œä½¿ç”¨ä¼ ç»Ÿæ¨¡å¼
    return traditional_generation()
```

### æ”¯æŒæŒä¹…åŒ–ç¼“å­˜

```python
# å½“å‰: å†…å­˜ç¼“å­˜
_llm_response_cache = {}

# æœªæ¥: Redis ç¼“å­˜
async def get_cache(key: str):
    return await redis_client.get(f"llm:{key}")

async def set_cache(key: str, value: Dict):
    await redis_client.setex(
        f"llm:{key}", 
        86400,  # TTL: 24h
        json.dumps(value)
    )
```

---

## ğŸ“‹ æ£€æŸ¥æ¸…å•

### å¼€å‘å®Œæˆæ£€æŸ¥
- [x] ç¼“å­˜æœºåˆ¶å®ç°
- [x] å¼‚æ­¥ä»»åŠ¡å®ç°
- [x] è¶…æ—¶æ§åˆ¶å®ç°
- [x] é™çº§é€»è¾‘å®ç°
- [x] å‰ç«¯è‡ªåŠ¨é€‰æ‹©å®ç°
- [x] ç±»å‹æ£€æŸ¥å®Œé€šè¿‡

### æµ‹è¯•å®Œæˆæ£€æŸ¥
- [x] ç¼“å­˜é”®è®¡ç®—æ­£ç¡®
- [x] LRU æ¸…ç†å·¥ä½œ
- [x] å¼‚æ­¥ä¸é˜»å¡å“åº”
- [x] è¶…æ—¶è‡ªåŠ¨è§¦å‘
- [x] é™çº§åŠŸèƒ½å·¥ä½œ
- [x] å‰ç«¯é€‰æ‹©æ­£ç¡®

### éƒ¨ç½²å®Œæˆæ£€æŸ¥
- [ ] ä»£ç å·²åˆå¹¶åˆ°ä¸»åˆ†æ”¯
- [ ] åç«¯å·²éƒ¨ç½²
- [ ] å‰ç«¯å·²éƒ¨ç½²
- [ ] ç›‘æ§å·²å¯ç”¨
- [ ] ç¼“å­˜å·²éªŒè¯
- [ ] æ€§èƒ½å·²æµ‹è¯•

---

## ğŸ”— ç›¸å…³æ–‡ä»¶é“¾æ¥

- å®ç°ä»£ç : `src/data_insight/chart_generator.py`
- å‰ç«¯ä»£ç : `web/src/app/charts/main.tsx`
- ä¼˜åŒ–æŒ‡å—: `docs/data-analysis-optimization.md`
- æ€»ç»“æ–‡æ¡£: `OPTIMIZATION_SUMMARY.md`
- å˜æ›´æ—¥å¿—: `CHANGES.md`

---

**ç‰ˆæœ¬**: 1.0
**æœ€åæ›´æ–°**: 2024-11-03
**ä½œè€…**: AI Assistant

