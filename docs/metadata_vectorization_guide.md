# å…ƒæ•°æ®å‘é‡åŒ–åŠŸèƒ½æŒ‡å—

## æ¦‚è¿°

å…ƒæ•°æ®å‘é‡åŒ–åŠŸèƒ½åŸºäºç³»ç»Ÿç°æœ‰çš„çŸ¥è¯†åº“Milvusé›†æˆæ–¹å¼ï¼Œå°†æ•°æ®åº“çš„å…ƒæ•°æ®ï¼ˆè¡¨ã€åˆ—ã€å…³ç³»ç­‰ä¿¡æ¯ï¼‰è½¬æ¢ä¸ºå‘é‡å¹¶å­˜å‚¨åˆ°Milvuså‘é‡æ•°æ®åº“ä¸­ï¼Œä¸ºåç»­çš„text2sqlåŠŸèƒ½æä¾›é«˜æ•ˆçš„è¯­ä¹‰æ£€ç´¢æ”¯æ’‘ã€‚

## åŠŸèƒ½ç‰¹æ€§

- ğŸ¯ **æ™ºèƒ½å‘é‡åŒ–**ï¼šå°†æ•°æ®åº“è¡¨ã€åˆ—ã€å…³ç³»ä¿¡æ¯è½¬æ¢ä¸ºè¯­ä¹‰å‘é‡
- ğŸ” **é«˜æ•ˆæ£€ç´¢**ï¼šåŸºäºMilvusçš„é«˜æ€§èƒ½æ··åˆæœç´¢ï¼ˆç¨ å¯†+ç¨€ç–å‘é‡ï¼‰
- ğŸ¤– **text2sqlæ”¯æ’‘**ï¼šä¸ºè‡ªç„¶è¯­è¨€è½¬SQLæä¾›å…ƒæ•°æ®æ£€ç´¢åŸºç¡€
- âš¡ **å®æ—¶æ›´æ–°**ï¼šæ”¯æŒå¢é‡æ›´æ–°å’Œå…¨é‡é‡å»º
- ğŸ“Š **è¿›åº¦ç›‘æ§**ï¼šå®æ—¶æŸ¥çœ‹å‘é‡åŒ–è¿›åº¦å’ŒçŠ¶æ€
- ğŸ”„ **é›†æˆå¤ç”¨**ï¼šåŸºäºç°æœ‰çŸ¥è¯†åº“åŠŸèƒ½çš„Milvusé›†æˆæ¶æ„

## ç³»ç»Ÿæ¶æ„

### åŸºäºç°æœ‰Milvusé›†æˆ

æœ¬åŠŸèƒ½å¤ç”¨äº†ç³»ç»Ÿä¸­ç°æœ‰çš„çŸ¥è¯†åº“åŠŸèƒ½çš„Milvusé›†æˆæ–¹å¼ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å‰ç«¯ç•Œé¢      â”‚    â”‚   åç«¯API       â”‚    â”‚   Milvus DB     â”‚
â”‚                 â”‚    â”‚                 â”‚    â”‚                 â”‚
â”‚ - å‘é‡åŒ–ç®¡ç†    â”‚â—„â”€â”€â–ºâ”‚ - å…ƒæ•°æ®API     â”‚â—„â”€â”€â–ºâ”‚ - çŸ¥è¯†åº“é›†åˆ    â”‚
â”‚ - çŠ¶æ€ç›‘æ§      â”‚    â”‚ - å‘é‡åŒ–æœåŠ¡    â”‚    â”‚ - å…ƒæ•°æ®é›†åˆ    â”‚
â”‚ - æœç´¢æµ‹è¯•      â”‚    â”‚ - æ£€ç´¢æ¥å£      â”‚    â”‚   (å¤ç”¨æ¶æ„)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                       â”‚   Ollama        â”‚
                       â”‚ Embedding Model â”‚
                       â”‚ (å¤ç”¨ç°æœ‰æ¨¡å‹)   â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å‘é‡åŒ–æµç¨‹

```mermaid
graph TD
    A[æ•°æ®æºå…ƒæ•°æ®] --> B[MetadataVectorizeService]
    B --> C[ç”Ÿæˆtext2sqlä¼˜åŒ–æè¿°]
    B --> D[åˆ›å»ºLangChain Document]
    C --> E[Ollama Embedding]
    D --> E
    E --> F[Milvuså­˜å‚¨]
    F --> G[ç¨ å¯†+ç¨€ç–å‘é‡æ£€ç´¢]
    G --> H[text2sqlæŸ¥è¯¢æ”¯æ’‘]
    
    style B fill:#e1f5fe
    style F fill:#f3e5f5
    style G fill:#e8f5e8
```

## ç¯å¢ƒé…ç½®

### 1. MilvusæœåŠ¡ï¼ˆå¤ç”¨ç°æœ‰é…ç½®ï¼‰

ç³»ç»Ÿå·²é…ç½®MilvusæœåŠ¡ï¼Œå…ƒæ•°æ®å‘é‡åŒ–å°†åˆ›å»ºç‹¬ç«‹çš„é›†åˆï¼š

```bash
# æ£€æŸ¥ç°æœ‰MilvusæœåŠ¡çŠ¶æ€
docker ps | grep milvus

# å¦‚æœæœªå¯åŠ¨ï¼Œä½¿ç”¨ç°æœ‰é…ç½®å¯åŠ¨
docker-compose up -d milvus
```

### 2. Ollama Embeddingæ¨¡å‹ï¼ˆå¤ç”¨ç°æœ‰é…ç½®ï¼‰

ç³»ç»Ÿå·²é…ç½®Ollama embeddingæ¨¡å‹ï¼Œæ— éœ€é¢å¤–å®‰è£…ï¼š

```bash
# æ£€æŸ¥æ¨¡å‹æ˜¯å¦å¯ç”¨
ollama list | grep nomic-embed-text

# å¦‚æœæœªå®‰è£…ï¼Œæ‹‰å–æ¨¡å‹
ollama pull nomic-embed-text
```

### 3. ç¯å¢ƒå˜é‡é…ç½®

```bash
# å¤åˆ¶ç¯å¢ƒå˜é‡é…ç½®
cp env.example .env
```

å…³é”®é…ç½®é¡¹ï¼š
```bash
# Milvusé…ç½®ï¼ˆå¤ç”¨ç°æœ‰ï¼‰
MILVUS_URL=http://localhost:19530
METADATA_COLLECTION_NAME=metadata_vectors

# Ollamaé…ç½®ï¼ˆå¤ç”¨ç°æœ‰ï¼‰
OLLAMA_EMBEDDING_MODEL=nomic-embed-text
OLLAMA_EMBEDDING_URL=http://localhost:11434
```

## ä½¿ç”¨æŒ‡å—

### 1. å‘é‡åŒ–æ•°æ®æºå…ƒæ•°æ®

#### é€šè¿‡Webç•Œé¢

1. è¿›å…¥**ç³»ç»Ÿç®¡ç†** > **æ•°æ®æºç®¡ç†**
2. æ‰¾åˆ°ç›®æ ‡æ•°æ®æºï¼Œç‚¹å‡»**å…ƒæ•°æ®ç®¡ç†**æŒ‰é’®
3. åˆ‡æ¢åˆ°**å‘é‡åŒ–ç®¡ç†**æ ‡ç­¾é¡µ
4. ç‚¹å‡»**å¼€å§‹å‘é‡åŒ–**æŒ‰é’®
5. ç›‘æ§å‘é‡åŒ–è¿›åº¦ç›´è‡³å®Œæˆ

#### é€šè¿‡APIæ¥å£

```bash
# å‘é‡åŒ–æŒ‡å®šæ•°æ®æºçš„å…ƒæ•°æ®
curl -X POST "http://localhost:8000/api/data-sources/{datasource_id}/metadata/vectorize" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer your-token" \
  -d '{
    "include_tables": true,
    "include_columns": true,
    "include_relationships": true,
    "include_indexes": false,
    "include_constraints": false
  }'
```

### 2. ç›‘æ§å‘é‡åŒ–çŠ¶æ€

```bash
# è·å–å‘é‡åŒ–çŠ¶æ€
curl -X GET "http://localhost:8000/api/data-sources/{datasource_id}/metadata/vectorize/status" \
  -H "Authorization: Bearer your-token"

# è·å–ç»Ÿè®¡ä¿¡æ¯
curl -X GET "http://localhost:8000/api/data-sources/{datasource_id}/metadata/vectorize/stats" \
  -H "Authorization: Bearer your-token"
```

### 3. æœç´¢å…ƒæ•°æ®å‘é‡

```bash
# æœç´¢ç›¸å…³å…ƒæ•°æ®
curl -X POST "http://localhost:8000/api/data-sources/metadata/search" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer your-token" \
  -d '{
    "query": "ç”¨æˆ·ä¿¡æ¯è¡¨",
    "datasource_ids": ["datasource-id-1"],
    "limit": 10
  }'
```

## å‘é‡åŒ–é…ç½®é€‰é¡¹

| é€‰é¡¹ | è¯´æ˜ | æ¨èè®¾ç½® | text2sqlå½±å“ |
|------|------|----------|--------------|
| `include_tables` | åŒ…å«è¡¨ä¿¡æ¯ | âœ… å¯ç”¨ | å½±å“è¡¨åè¯†åˆ«å’Œé€‰æ‹© |
| `include_columns` | åŒ…å«åˆ—ä¿¡æ¯ | âœ… å¯ç”¨ | å½±å“å­—æ®µåè¯†åˆ«å’Œç±»å‹æ¨æ–­ |
| `include_relationships` | åŒ…å«å…³ç³»ä¿¡æ¯ | âœ… å¯ç”¨ | å½±å“è¡¨å…³è”æŸ¥è¯¢ç”Ÿæˆ |
| `include_indexes` | åŒ…å«ç´¢å¼•ä¿¡æ¯ | âŒ ç¦ç”¨ | å¯¹text2sqlå½±å“è¾ƒå° |
| `include_constraints` | åŒ…å«çº¦æŸä¿¡æ¯ | âŒ ç¦ç”¨ | å¯¹text2sqlå½±å“è¾ƒå° |

## å‘é‡åŒ–æ•°æ®ç»“æ„

### è¡¨ä¿¡æ¯å‘é‡åŒ–

åŸºäºç°æœ‰embeddingæ¨¡å‹ç”Ÿæˆçš„ä¼˜åŒ–æè¿°ï¼š
```text
è¡¨å: users (åº“: main), ä¸šåŠ¡æè¿°: ç”¨æˆ·ä¿¡æ¯è¡¨ï¼Œå­˜å‚¨ç³»ç»Ÿç”¨æˆ·çš„åŸºæœ¬ä¿¡æ¯å’ŒçŠ¶æ€, å…³é”®è¯: ç”¨æˆ·, ä¿¡æ¯, è®°å½•æ•°: 10000æ¡, ä¸»è¦å­—æ®µ: id, username, email, ä¸»è¦åˆ—: id(int)[ç”¨æˆ·å”¯ä¸€æ ‡è¯†], username(varchar)[ç”¨æˆ·ç™»å½•å], email(varchar)[é‚®ç®±åœ°å€], created_at(timestamp)[åˆ›å»ºæ—¶é—´], status(tinyint)[ç”¨æˆ·çŠ¶æ€], ä¸šåŠ¡å­—æ®µ: username: ç”¨æˆ·ç™»å½•å; email: é‚®ç®±åœ°å€; status: ç”¨æˆ·çŠ¶æ€; created_at: åˆ›å»ºæ—¶é—´
```

### åˆ—ä¿¡æ¯å‘é‡åŒ–

```text
å­—æ®µ: users.status, ç±»å‹: tinyint, ä¸šåŠ¡å«ä¹‰: ç”¨æˆ·çŠ¶æ€, æ•°æ®æ ¼å¼: 1=æ´»è·ƒï¼Œ0=éæ´»è·ƒ, å®Œæ•´è¯´æ˜: ç”¨æˆ·çŠ¶æ€ï¼Œ1=æ´»è·ƒï¼Œ0=éæ´»è·ƒï¼Œé»˜è®¤ä¸º1, çº¦æŸ: å¿…å¡«
```

### å…³ç³»ä¿¡æ¯å‘é‡åŒ–

```text
è¡¨å…³ç³»: orders.user_id å…³è” users.id
```

## æŠ€æœ¯å®ç°ç»†èŠ‚

### 1. å‘é‡å­˜å‚¨æ¶æ„

- **å¤ç”¨LangChain-Milvusé›†æˆ**ï¼šåŸºäº `langchain_milvus.Milvus`
- **æ··åˆå‘é‡æ”¯æŒ**ï¼šç¨ å¯†å‘é‡ï¼ˆOllamaï¼‰+ ç¨€ç–å‘é‡ï¼ˆBM25ï¼‰
- **å…ƒæ•°æ®è¿‡æ»¤**ï¼šæ”¯æŒæŒ‰æ•°æ®æºIDè¿›è¡Œç²¾ç¡®è¿‡æ»¤
- **é›†åˆéš”ç¦»**ï¼šç‹¬ç«‹çš„ `metadata_vectors` é›†åˆ

### 2. æ–‡æ¡£ç»“æ„

```python
Document(
    page_content="è¡¨å: users, æè¿°: ç”¨æˆ·ä¿¡æ¯è¡¨...",
    metadata={
        "datasource_id": "uuid",
        "item_type": "table|column|relationship",
        "item_name": "users",
        "table_name": "users",
        "raw_data": "{...åŸå§‹JSONæ•°æ®...}"
    }
)
```

### 3. æœç´¢ç­–ç•¥

- **åŠ æƒæ··åˆæ£€ç´¢**ï¼šç¨ å¯†å‘é‡70% + ç¨€ç–å‘é‡30%
- **å…ƒæ•°æ®è¿‡æ»¤**ï¼šæ”¯æŒæŒ‰æ•°æ®æºIDã€é¡¹ç›®ç±»å‹è¿‡æ»¤
- **ç›¸ä¼¼åº¦æ’åº**ï¼šåŸºäºå‘é‡è·ç¦»å’ŒBM25åˆ†æ•°

## æ€§èƒ½ä¼˜åŒ–

### 1. å‘é‡åŒ–æ€§èƒ½

- **æ‰¹é‡å¤„ç†**ï¼šæ¯æ‰¹å¤„ç†100ä¸ªæ–‡æ¡£
- **å¤ç”¨è¿æ¥**ï¼šåˆ©ç”¨ç°æœ‰Milvusè¿æ¥æ± 
- **å¢é‡æ›´æ–°**ï¼šä»…æ›´æ–°å˜æ›´çš„å…ƒæ•°æ®

### 2. æœç´¢æ€§èƒ½

- **ç´¢å¼•å¤ç”¨**ï¼šåˆ©ç”¨ç°æœ‰Milvusç´¢å¼•ç­–ç•¥
- **ç¼“å­˜æœºåˆ¶**ï¼šçŠ¶æ€ä¿¡æ¯å†…å­˜ç¼“å­˜
- **å¹¶å‘å¤„ç†**ï¼šæ”¯æŒå¤šæ•°æ®æºå¹¶è¡Œå‘é‡åŒ–

## ä¸ç°æœ‰åŠŸèƒ½çš„é›†æˆ

### 1. çŸ¥è¯†åº“åŠŸèƒ½ååŒ

- **å…±äº«Milvuså®ä¾‹**ï¼šå¤ç”¨ç°æœ‰å‘é‡æ•°æ®åº“
- **ç»Ÿä¸€Embeddingæ¨¡å‹**ï¼šä½¿ç”¨ç›¸åŒçš„Ollamaæ¨¡å‹
- **ä¸€è‡´çš„APIè®¾è®¡**ï¼šéµå¾ªç°æœ‰çŸ¥è¯†åº“APIæ¨¡å¼

### 2. æ•°æ®æºç®¡ç†é›†æˆ

- **æ— ç¼UIé›†æˆ**ï¼šåœ¨ç°æœ‰æ•°æ®æºç®¡ç†ç•Œé¢ä¸­æ·»åŠ å‘é‡åŒ–åŠŸèƒ½
- **çŠ¶æ€åŒæ­¥**ï¼šä¸å…ƒæ•°æ®ç®¡ç†çŠ¶æ€åè°ƒ
- **æƒé™å¤ç”¨**ï¼šä½¿ç”¨ç°æœ‰çš„ç”¨æˆ·æƒé™ä½“ç³»

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

#### 1. Milvusè¿æ¥å¤±è´¥

```bash
# æ£€æŸ¥MilvusæœåŠ¡çŠ¶æ€
docker ps | grep milvus

# æ£€æŸ¥è¿æ¥é…ç½®
echo $MILVUS_URL

# æµ‹è¯•è¿æ¥
curl http://localhost:19530/health
```

#### 2. Ollamaæ¨¡å‹ä¸å¯ç”¨

```bash
# æ£€æŸ¥OllamaæœåŠ¡
curl http://localhost:11434/api/version

# æ£€æŸ¥æ¨¡å‹åˆ—è¡¨
ollama list

# é‡æ–°æ‹‰å–æ¨¡å‹
ollama pull nomic-embed-text
```

#### 3. å‘é‡åŒ–è¿›åº¦å¡ä½

- æ£€æŸ¥æ•°æ®æºè¿æ¥çŠ¶æ€
- æŸ¥çœ‹åº”ç”¨æ—¥å¿—ä¸­çš„é”™è¯¯ä¿¡æ¯
- éªŒè¯å…ƒæ•°æ®è·å–æ˜¯å¦æ­£å¸¸

### ç›‘æ§å’Œè°ƒè¯•

```bash
# æŸ¥çœ‹å‘é‡åŒ–æ—¥å¿—
tail -f logs/app.log | grep vectorize

# æ£€æŸ¥Milvusé›†åˆçŠ¶æ€
# é€šè¿‡Milvusç®¡ç†ç•Œé¢æˆ–CLIå·¥å…·

# æµ‹è¯•embeddingæœåŠ¡
curl -X POST http://localhost:11434/api/embeddings \
  -d '{"model": "nomic-embed-text", "prompt": "test"}'
```

## APIå‚è€ƒ

### å‘é‡åŒ–ç›¸å…³æ¥å£

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| POST | `/api/data-sources/{id}/metadata/vectorize` | å‘é‡åŒ–å…ƒæ•°æ® |
| GET | `/api/data-sources/{id}/metadata/vectorize/status` | è·å–å‘é‡åŒ–çŠ¶æ€ |
| GET | `/api/data-sources/{id}/metadata/vectorize/stats` | è·å–ç»Ÿè®¡ä¿¡æ¯ |
| DELETE | `/api/data-sources/{id}/metadata/vectors` | åˆ é™¤å…ƒæ•°æ®å‘é‡ |
| POST | `/api/data-sources/metadata/search` | æœç´¢å…ƒæ•°æ®å‘é‡ |

### æ•°æ®æ¨¡å‹

```typescript
interface VectorizeRequest {
  include_tables: boolean;
  include_columns: boolean;
  include_relationships: boolean;
  include_indexes: boolean;
  include_constraints: boolean;
}

interface VectorizeResponse {
  success: boolean;
  vectors_count: number;
  collection_name: string;
  processing_time: number;
  message: string;
}
```

## æœ€ä½³å®è·µ

### 1. å‘é‡åŒ–æ—¶æœº

- **æ–°æ•°æ®æº**ï¼šæ·»åŠ æ•°æ®æºåç«‹å³å‘é‡åŒ–
- **ç»“æ„å˜æ›´**ï¼šæ•°æ®åº“ç»“æ„å˜æ›´åé‡æ–°å‘é‡åŒ–
- **å®šæœŸç»´æŠ¤**ï¼šå»ºè®®æ¯å‘¨é‡æ–°å‘é‡åŒ–ä»¥ä¿æŒæ•°æ®ä¸€è‡´æ€§

### 2. text2sqlé›†æˆ

- **è¯­ä¹‰åŒ¹é…**ï¼šåˆ©ç”¨æ··åˆæœç´¢åŒ¹é…ç”¨æˆ·æŸ¥è¯¢æ„å›¾
- **ä¸Šä¸‹æ–‡å¢å¼º**ï¼šç»“åˆå‘é‡æœç´¢ç»“æœç”Ÿæˆæ›´å‡†ç¡®çš„SQL
- **å¤šè¡¨å…³è”**ï¼šé€šè¿‡å…³ç³»å‘é‡è¯†åˆ«è¡¨é—´å…³è”å…³ç³»

### 3. è¿ç»´ç›‘æ§

- **å‘é‡æ•°é‡ç›‘æ§**ï¼šå®šæœŸæ£€æŸ¥å‘é‡æ•°é‡æ˜¯å¦ä¸å…ƒæ•°æ®ä¸€è‡´
- **æœç´¢æ€§èƒ½ç›‘æ§**ï¼šç›‘æ§å‘é‡æœç´¢å“åº”æ—¶é—´
- **å­˜å‚¨ç©ºé—´ç›‘æ§**ï¼šç›‘æ§Milvuså­˜å‚¨ç©ºé—´ä½¿ç”¨æƒ…å†µ

## åç»­å¼€å‘è®¡åˆ’

- [ ] æ”¯æŒæ›´å¤šembeddingæ¨¡å‹é€‰æ‹©
- [ ] æ·»åŠ å‘é‡è´¨é‡è¯„ä¼°æŒ‡æ ‡
- [ ] å®ç°å¢é‡å‘é‡åŒ–ä¼˜åŒ–
- [ ] é›†æˆåˆ°chatbotçš„text2sqlæµç¨‹
- [ ] æ·»åŠ å‘é‡åŒ–ä»»åŠ¡è°ƒåº¦å™¨
- [ ] æ”¯æŒè‡ªå®šä¹‰å‘é‡åŒ–è§„åˆ™

## æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·ï¼š

1. æŸ¥çœ‹ç³»ç»Ÿæ—¥å¿—è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯
2. å‚è€ƒæœ¬æ–‡æ¡£çš„æ•…éšœæ’é™¤éƒ¨åˆ†
3. æ£€æŸ¥Milvuså’ŒOllamaæœåŠ¡çŠ¶æ€
4. åœ¨é¡¹ç›®ä»“åº“æäº¤Issue

---

*æœ€åæ›´æ–°æ—¶é—´ï¼š2024å¹´12æœˆ*
*åŸºäºç°æœ‰çŸ¥è¯†åº“Milvusé›†æˆæ¶æ„å®ç°* 