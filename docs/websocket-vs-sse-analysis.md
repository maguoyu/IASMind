# WebSocket vs SSE åè®®é€‰æ‹©åˆ†æ

## ä¸€ã€åè®®å¯¹æ¯”

### WebSocket ç‰¹ç‚¹

**ä¼˜åŠ¿ï¼š**
- âœ… **å…¨åŒå·¥é€šä¿¡**ï¼šå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨å¯ä»¥åŒæ—¶å‘é€å’Œæ¥æ”¶æ•°æ®
- âœ… **ä½å»¶è¿Ÿ**ï¼šå»ºç«‹è¿æ¥åï¼Œæ•°æ®ä¼ è¾“å»¶è¿Ÿæä½
- âœ… **äºŒè¿›åˆ¶æ”¯æŒ**ï¼šå¯ä»¥ä¼ è¾“äºŒè¿›åˆ¶æ•°æ®ï¼Œé€‚åˆä¼ è¾“å¤§é‡æ•°æ®
- âœ… **è¿æ¥æŒä¹…åŒ–**ï¼šä¸€æ¬¡æ¡æ‰‹ï¼Œé•¿æœŸä¿æŒè¿æ¥
- âœ… **é€‚åˆäº¤äº’å¼åœºæ™¯**ï¼šéœ€è¦é¢‘ç¹åŒå‘é€šä¿¡çš„åœºæ™¯

**åŠ£åŠ¿ï¼š**
- âŒ **å®ç°å¤æ‚åº¦é«˜**ï¼šéœ€è¦å¤„ç†è¿æ¥ç®¡ç†ã€å¿ƒè·³ã€é‡è¿ç­‰
- âŒ **æœåŠ¡å™¨èµ„æºæ¶ˆè€—å¤§**ï¼šæ¯ä¸ªè¿æ¥å ç”¨æœåŠ¡å™¨èµ„æº
- âŒ **ä»£ç†/é˜²ç«å¢™é—®é¢˜**ï¼šæŸäº›ä»£ç†æœåŠ¡å™¨å¯èƒ½ä¸æ”¯æŒ WebSocket
- âŒ **éœ€è¦é¢å¤–åº“**ï¼šå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨éƒ½éœ€è¦ WebSocket åº“

### SSE (Server-Sent Events) ç‰¹ç‚¹

**ä¼˜åŠ¿ï¼š**
- âœ… **å®ç°ç®€å•**ï¼šåŸºäº HTTPï¼Œä½¿ç”¨æ ‡å‡† fetch API
- âœ… **è‡ªåŠ¨é‡è¿**ï¼šæµè§ˆå™¨åŸç”Ÿæ”¯æŒè‡ªåŠ¨é‡è¿æœºåˆ¶
- âœ… **HTTP å…¼å®¹æ€§å¥½**ï¼šé€šè¿‡æ ‡å‡† HTTP åè®®ï¼Œä»£ç†/é˜²ç«å¢™å‹å¥½
- âœ… **æœåŠ¡å™¨èµ„æºæ¶ˆè€—ä½**ï¼šåŸºäº HTTP é•¿è¿æ¥ï¼Œèµ„æºå ç”¨ç›¸å¯¹è¾ƒå°‘
- âœ… **é¡¹ç›®å·²æœ‰åŸºç¡€**ï¼šé¡¹ç›®ä¸­å·²ç»åœ¨ä½¿ç”¨ SSEï¼ˆLLMã€æ•°æ®åº“åˆ†æç­‰ï¼‰

**åŠ£åŠ¿ï¼š**
- âŒ **å•å‘é€šä¿¡**ï¼šåªèƒ½æœåŠ¡å™¨å‘å®¢æˆ·ç«¯æ¨é€æ•°æ®
- âŒ **æ–‡æœ¬æ ¼å¼**ï¼šåªæ”¯æŒæ–‡æœ¬æ•°æ®ï¼ˆJSONï¼‰ï¼Œä¸æ”¯æŒäºŒè¿›åˆ¶
- âŒ **æµè§ˆå™¨é™åˆ¶**ï¼šéƒ¨åˆ†è€ç‰ˆæœ¬æµè§ˆå™¨ä¸æ”¯æŒ

## äºŒã€è‡ªåŠ¨æ´¾å·¥å›æ”¾ç³»ç»Ÿéœ€æ±‚åˆ†æ

### å½“å‰ç³»ç»Ÿç‰¹ç‚¹

1. **æ•°æ®æµå‘**ï¼š
   - ä¸»è¦ï¼šæœåŠ¡å™¨ â†’ å®¢æˆ·ç«¯ï¼ˆæ¨é€è½¦è¾†ä½ç½®ã€ä»»åŠ¡çŠ¶æ€ã€èˆªç­ä¿¡æ¯ï¼‰
   - æ¬¡è¦ï¼šå®¢æˆ·ç«¯ â†’ æœåŠ¡å™¨ï¼ˆæ§åˆ¶æ’­æ”¾ã€æš‚åœã€å¿«è¿›ã€æ—¶é—´èŒƒå›´é€‰æ‹©ï¼‰

2. **æ•°æ®ç‰¹ç‚¹**ï¼š
   - æ•°æ®æ ¼å¼ï¼šJSONï¼ˆè½¦è¾†ä½ç½®ã€ä»»åŠ¡çŠ¶æ€ç­‰ï¼‰
   - æ•°æ®é¢‘ç‡ï¼šä¸­ç­‰ï¼ˆæ¯ç§’å‡ æ¬¡åˆ°å‡ åæ¬¡ï¼‰
   - æ•°æ®é‡ï¼šä¸­ç­‰ï¼ˆæ¯ä¸ªäº‹ä»¶å‡  KBï¼‰

3. **äº¤äº’ç‰¹ç‚¹**ï¼š
   - å®¢æˆ·ç«¯æ§åˆ¶ï¼šæ’­æ”¾/æš‚åœã€æ—¶é—´èŒƒå›´ã€æ’­æ”¾é€Ÿåº¦
   - æœåŠ¡å™¨æ¨é€ï¼šå®æ—¶ä½ç½®æ›´æ–°ã€çŠ¶æ€å˜åŒ–

### ä½¿ç”¨åœºæ™¯å¯¹æ¯”

| åœºæ™¯ | WebSocket | SSE | æ¨è |
|------|-----------|-----|------|
| å®æ—¶ä½ç½®æ¨é€ | âœ… é€‚åˆ | âœ… é€‚åˆ | SSEï¼ˆæ›´ç®€å•ï¼‰ |
| æ’­æ”¾æ§åˆ¶ | âœ… é€‚åˆ | âš ï¸ éœ€è¦ HTTP è¯·æ±‚ | WebSocketï¼ˆæ›´æµç•…ï¼‰ |
| å†å²æ•°æ®å›æ”¾ | âœ… é€‚åˆ | âœ… é€‚åˆ | SSEï¼ˆå·²æœ‰åŸºç¡€ï¼‰ |
| å¤šç”¨æˆ·å¹¶å‘ | âš ï¸ èµ„æºæ¶ˆè€—å¤§ | âœ… èµ„æºæ¶ˆè€—å° | SSE |
| æ–­çº¿é‡è¿ | âš ï¸ éœ€è¦æ‰‹åŠ¨å®ç° | âœ… è‡ªåŠ¨é‡è¿ | SSE |

## ä¸‰ã€æ¨èæ–¹æ¡ˆ

### ğŸ¯ **æ¨èä½¿ç”¨ SSE + HTTP REST API æ··åˆæ–¹æ¡ˆ**

#### æ–¹æ¡ˆæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å®¢æˆ·ç«¯    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€â”€â”€ SSE è¿æ¥ â”€â”€â”€â”€> æœåŠ¡å™¨æ¨é€ï¼ˆè½¦è¾†ä½ç½®ã€ä»»åŠ¡çŠ¶æ€ã€èˆªç­ä¿¡æ¯ï¼‰
       â”‚
       â””â”€â”€â”€ HTTP REST â”€â”€> å®¢æˆ·ç«¯æ§åˆ¶ï¼ˆæ’­æ”¾/æš‚åœã€æ—¶é—´èŒƒå›´ã€é€Ÿåº¦ï¼‰
```

#### å®ç°æ–¹å¼

1. **SSE ç”¨äºæ•°æ®æ¨é€**ï¼š
   - è½¦è¾†å®æ—¶ä½ç½®æ›´æ–°
   - ä»»åŠ¡çŠ¶æ€å˜åŒ–
   - èˆªç­åˆ°è¾¾/èµ·é£äº‹ä»¶
   - ç³»ç»Ÿé€šçŸ¥

2. **HTTP REST API ç”¨äºæ§åˆ¶**ï¼š
   - è®¾ç½®æ’­æ”¾å‚æ•°ï¼ˆå¼€å§‹æ—¶é—´ã€ç»“æŸæ—¶é—´ã€æ’­æ”¾é€Ÿåº¦ï¼‰
   - æ’­æ”¾/æš‚åœæ§åˆ¶
   - æŸ¥è¯¢å†å²æ•°æ®
   - ç­›é€‰æ¡ä»¶å˜æ›´

#### ä¼˜åŠ¿

1. **å¤ç”¨ç°æœ‰åŸºç¡€è®¾æ–½**ï¼š
   - é¡¹ç›®å·²æœ‰ SSE å®ç°ï¼ˆ`fetch-stream.ts`ï¼‰
   - æœåŠ¡å™¨å·²æœ‰ SSE è·¯ç”±å®ç°ç»éªŒ
   - ä»£ç é£æ ¼ç»Ÿä¸€

2. **å®ç°ç®€å•**ï¼š
   - SSE å®ç°ç®€å•ï¼Œç»´æŠ¤æˆæœ¬ä½
   - HTTP REST API æ ‡å‡†å®ç°
   - æ— éœ€é¢å¤–çš„ WebSocket åº“

3. **èµ„æºæ¶ˆè€—ä½**ï¼š
   - SSE è¿æ¥èµ„æºæ¶ˆè€—å°
   - é€‚åˆå¤šç”¨æˆ·å¹¶å‘åœºæ™¯

4. **å…¼å®¹æ€§å¥½**ï¼š
   - HTTP åè®®ï¼Œä»£ç†/é˜²ç«å¢™å‹å¥½
   - æµè§ˆå™¨æ”¯æŒå¹¿æ³›

5. **æ˜“äºè°ƒè¯•**ï¼š
   - å¯ä»¥ä½¿ç”¨æµè§ˆå™¨å¼€å‘è€…å·¥å…·æŸ¥çœ‹ SSE äº‹ä»¶
   - HTTP è¯·æ±‚æ˜“äºæµ‹è¯•å’Œè°ƒè¯•

#### ä»£ç ç¤ºä¾‹

**å®¢æˆ·ç«¯ SSE è¿æ¥**ï¼š
```typescript
// ä½¿ç”¨é¡¹ç›®ç°æœ‰çš„ fetchStream
import { fetchStream } from "~/core/sse/fetch-stream";

async function connectReplayStream(params: {
  airportId: string;
  startTime: string;
  endTime: string;
  playbackSpeed: number;
}) {
  const stream = fetchStream("/api/auto_dispatch/replay/stream", {
    method: "POST",
    body: JSON.stringify(params),
  });

  for await (const event of stream) {
    if (event.event === "vehicle_update") {
      // æ›´æ–°è½¦è¾†ä½ç½®
      updateVehiclePosition(JSON.parse(event.data));
    } else if (event.event === "task_update") {
      // æ›´æ–°ä»»åŠ¡çŠ¶æ€
      updateTaskStatus(JSON.parse(event.data));
    } else if (event.event === "flight_update") {
      // æ›´æ–°èˆªç­ä¿¡æ¯
      updateFlightInfo(JSON.parse(event.data));
    }
  }
}
```

**æœåŠ¡å™¨ SSE å®ç°**ï¼š
```python
@router.post("/auto_dispatch/replay/stream")
async def replay_stream(
    request: ReplayRequest,
    http_request: Request
):
    async def generate_stream():
        # æ ¹æ®æ—¶é—´èŒƒå›´å’Œæ’­æ”¾é€Ÿåº¦æ¨é€æ•°æ®
        current_time = request.start_time
        while current_time <= request.end_time:
            # æ£€æŸ¥å®¢æˆ·ç«¯æ˜¯å¦æ–­å¼€
            if await http_request.is_disconnected():
                break
            
            # è·å–å½“å‰æ—¶é—´ç‚¹çš„æ•°æ®
            data = get_replay_data(
                airport_id=request.airport_id,
                timestamp=current_time
            )
            
            # æ¨é€è½¦è¾†ä½ç½®
            yield f"event: vehicle_update\ndata: {json.dumps(data['vehicles'])}\n\n"
            
            # æ¨é€ä»»åŠ¡çŠ¶æ€
            yield f"event: task_update\ndata: {json.dumps(data['tasks'])}\n\n"
            
            # æ¨é€èˆªç­ä¿¡æ¯
            yield f"event: flight_update\ndata: {json.dumps(data['flights'])}\n\n"
            
            # æ ¹æ®æ’­æ”¾é€Ÿåº¦æ¨è¿›æ—¶é—´
            current_time += timedelta(seconds=1 / request.playback_speed)
            await asyncio.sleep(1 / request.playback_speed)
    
    return StreamingResponse(
        generate_stream(),
        media_type="text/event-stream",
        headers={
            "Cache-Control": "no-cache",
            "Connection": "keep-alive",
        }
    )
```

**HTTP REST API æ§åˆ¶**ï¼š
```python
@router.post("/auto_dispatch/replay/control")
async def control_replay(
    control: ReplayControlRequest
):
    # å¤„ç†æ’­æ”¾æ§åˆ¶ï¼ˆæ’­æ”¾/æš‚åœ/è·³è½¬ï¼‰
    # æ›´æ–°æœåŠ¡å™¨ç«¯æ’­æ”¾çŠ¶æ€
    return {"status": "success"}

@router.post("/auto_dispatch/replay/set-params")
async def set_replay_params(
    params: ReplayParamsRequest
):
    # è®¾ç½®æ’­æ”¾å‚æ•°ï¼ˆæ—¶é—´èŒƒå›´ã€é€Ÿåº¦ã€ç­›é€‰æ¡ä»¶ï¼‰
    return {"status": "success"}
```

## å››ã€ä½•æ—¶è€ƒè™‘ä½¿ç”¨ WebSocket

å¦‚æœæœªæ¥ç³»ç»Ÿéœ€è¦ä»¥ä¸‹åŠŸèƒ½ï¼Œå¯ä»¥è€ƒè™‘è¿ç§»åˆ° WebSocketï¼š

1. **å®æ—¶åŒå‘é€šä¿¡**ï¼šéœ€è¦å®¢æˆ·ç«¯é¢‘ç¹å‘æœåŠ¡å™¨å‘é€æ•°æ®
2. **äºŒè¿›åˆ¶æ•°æ®ä¼ è¾“**ï¼šéœ€è¦ä¼ è¾“å¤§é‡äºŒè¿›åˆ¶æ•°æ®ï¼ˆå¦‚è§†é¢‘æµï¼‰
3. **ä½å»¶è¿Ÿè¦æ±‚æé«˜**ï¼šæ¯«ç§’çº§å»¶è¿Ÿè¦æ±‚
4. **å¤æ‚äº¤äº’åœºæ™¯**ï¼šéœ€è¦å¤æ‚çš„åŒå‘äº¤äº’é€»è¾‘

## äº”ã€æ€»ç»“

**å¯¹äºè‡ªåŠ¨æ´¾å·¥å›æ”¾ç³»ç»Ÿï¼Œæ¨èä½¿ç”¨ SSE + HTTP REST API æ–¹æ¡ˆ**ï¼ŒåŸå› ï¼š

1. âœ… ç¬¦åˆç³»ç»Ÿéœ€æ±‚ï¼ˆä¸»è¦æ˜¯æœåŠ¡å™¨æ¨é€ï¼Œå°‘é‡å®¢æˆ·ç«¯æ§åˆ¶ï¼‰
2. âœ… å®ç°ç®€å•ï¼Œç»´æŠ¤æˆæœ¬ä½
3. âœ… å¤ç”¨é¡¹ç›®ç°æœ‰åŸºç¡€è®¾æ–½
4. âœ… èµ„æºæ¶ˆè€—ä½ï¼Œé€‚åˆå¤šç”¨æˆ·åœºæ™¯
5. âœ… å…¼å®¹æ€§å¥½ï¼Œæ˜“äºè°ƒè¯•

å¦‚æœæœªæ¥éœ€æ±‚å˜åŒ–ï¼Œå¯ä»¥å¹³æ»‘è¿ç§»åˆ° WebSocketï¼Œä½†å½“å‰é˜¶æ®µ SSE æ–¹æ¡ˆå·²ç»è¶³å¤Ÿæ»¡è¶³éœ€æ±‚ã€‚

