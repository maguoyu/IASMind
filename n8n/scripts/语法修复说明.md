# n8n Python Code Tool è¯­æ³•ä¿®å¤è¯´æ˜

## ğŸ”´ é—®é¢˜è¯´æ˜

### é”™è¯¯ 1: `SyntaxError: invalid syntax`
**æ ¹æœ¬åŸå› **: Python ä»£ç ä¸­ä½¿ç”¨äº† JavaScript è¯­æ³•ï¼

### é”™è¯¯ 2: `Wrong output type returned`
**æ ¹æœ¬åŸå› **: è¿”å›äº† JSON å­—ç¬¦ä¸²è€Œä¸æ˜¯ Python å­—å…¸ï¼

## âš ï¸ é”™è¯¯çš„ä»£ç ï¼ˆä¿®å¤å‰ï¼‰

```python
# âŒ è¿™æ˜¯ JavaScript è¯­æ³•ï¼Œåœ¨ Python ä¸­ä¼šæŠ¥é”™ï¼
contract_text = $input.first().json.get('contractText', '')
contract_amount = $input.first().json.get('contractAmount', 0)

result = assess_contract_risks(contract_text, contract_amount)
return {'json': {'riskAssessment': result}}
```

**é—®é¢˜ç‚¹**:
1. `$input.first()` - è¿™æ˜¯ JavaScript è¯­æ³•ï¼Œ`$` åœ¨ Python ä¸­æ˜¯éæ³•å­—ç¬¦
2. `.json.get()` - JavaScript é“¾å¼è°ƒç”¨
3. `return {'json': {...}}` - JavaScript çš„è¿”å›æ ¼å¼
4. `json.dumps()` - è¿”å› JSON å­—ç¬¦ä¸²è€Œä¸æ˜¯å­—å…¸å¯¹è±¡

## âœ… æ­£ç¡®çš„ä»£ç ï¼ˆä¿®å¤åï¼‰

### ä¿®å¤ 1: æ­£ç¡®çš„è¾“å…¥è®¿é—®è¯­æ³•

```python
# âœ… n8n Python Code Tool çš„æ­£ç¡®è¯­æ³•
for item in _input.all():
    contract_text = item.get('contractText', '')
    contract_amount = item.get('contractAmount', 0)
    
    result = assess_contract_risks(contract_text, contract_amount)
    _result = result  # ç›´æ¥ä½¿ç”¨å­—å…¸ï¼Œä¸è¦ json.dumps()
```

**ä¿®å¤è¦ç‚¹**:
1. `_input.all()` - ä½¿ç”¨ä¸‹åˆ’çº¿å‰ç¼€çš„ Python å¯¹è±¡ï¼ˆæ³¨æ„ï¼šæ˜¯ä¸‹åˆ’çº¿ï¼Œä¸æ˜¯ç¾å…ƒç¬¦å·ï¼‰
2. `for item in` - Python æ ‡å‡†çš„å¾ªç¯è¯­æ³•
3. `item.get()` - Python å­—å…¸çš„ get æ–¹æ³•
4. `_result = result` - ç›´æ¥èµ‹å€¼å­—å…¸å¯¹è±¡ï¼Œ**ä¸è¦è½¬æˆ JSON å­—ç¬¦ä¸²**

### ä¿®å¤ 2: æ­£ç¡®çš„è¾“å‡ºç±»å‹

```python
def assess_contract_risks(contract_text, contract_amount):
    risks = {
        "æ€»ä½“é£é™©è¯„åˆ†": 0,
        "ä»·æ ¼é£é™©": {"è¯„åˆ†": 0, "è¯´æ˜": ""}
    }
    # ... å¤„ç†é€»è¾‘ ...
    
    # âŒ é”™è¯¯ï¼šè¿”å› JSON å­—ç¬¦ä¸²
    # return json.dumps(risks, ensure_ascii=False, indent=2)
    
    # âœ… æ­£ç¡®ï¼šç›´æ¥è¿”å›å­—å…¸
    return risks

# n8n è°ƒç”¨æ¥å£
for item in _input.all():
    result = assess_contract_risks(...)
    # âŒ é”™è¯¯ï¼šåŒ…è£…æˆé¢å¤–çš„å­—å…¸
    # _result = {'riskAssessment': result}
    
    # âœ… æ­£ç¡®ï¼šç›´æ¥ä½¿ç”¨è¿”å›çš„å­—å…¸
    _result = result
```

## ğŸ“Š å®Œæ•´çš„è¯­æ³•å¯¹ç…§è¡¨

| åŠŸèƒ½ | âŒ JavaScript (n8n) | âœ… Python (n8n) |
|------|---------------------|-----------------|
| **è·å–ç¬¬ä¸€ä¸ªè¾“å…¥é¡¹** | `$input.first()` | `_input.all()[0]` æˆ–å¾ªç¯ |
| **è·å–æ‰€æœ‰è¾“å…¥é¡¹** | `$input.all()` | `_input.all()` |
| **è®¿é—® JSON æ•°æ®** | `$json.body.field` | `item.get('field')` |
| **è®¿é—®åµŒå¥—å­—æ®µ** | `$json.body.user.name` | `item.get('user', {}).get('name')` |
| **è¿”å›å•ä¸ªç»“æœ** | `return {'json': data}` | `_result = data` |
| **è¿”å›å¤šä¸ªç»“æœ** | `return [{json: d1}, {json: d2}]` | å¾ªç¯ä¸­å¤šæ¬¡èµ‹å€¼ `_result` |
| **ç¯å¢ƒå˜é‡** | `$env.API_KEY` | `os.environ.get('API_KEY')` |

## ğŸ“ å·²ä¿®å¤çš„æ–‡ä»¶

### 1. contract_risk_assessment.py âœ…
```python
# ä¿®å¤å‰
contract_text = $input.first().json.get('contractText', '')

# ä¿®å¤å
for item in _input.all():
    contract_text = item.get('contractText', '')
```

### 2. compliance_checker.py âœ…
```python
# ä¿®å¤å‰
contract_text = $input.first().json.get('contractText', '')

# ä¿®å¤å
for item in _input.all():
    contract_text = item.get('contractText', '')
```

### 3. terms_extractor.py âœ…
```python
# ä¿®å¤å‰
contract_text = $input.first().json.get('contractText', '')

# ä¿®å¤å
for item in _input.all():
    contract_text = item.get('contractText', '')
```

### 4. aviation-fuel-contract-review.json âœ…
JSON æ–‡ä»¶ä¸­åµŒå…¥çš„ Python ä»£ç ä¹Ÿå·²å…¨éƒ¨ä¿®å¤ã€‚

## ğŸ¯ n8n Python Code Tool æ ¸å¿ƒè¦ç‚¹

### 1. è¾“å…¥æ•°æ®è®¿é—®

```python
# è·å–æ‰€æœ‰è¾“å…¥é¡¹ï¼ˆè¿”å›åˆ—è¡¨ï¼‰
all_items = _input.all()

# å¾ªç¯å¤„ç†æ¯ä¸ªè¾“å…¥é¡¹
for item in _input.all():
    # item æ˜¯ä¸€ä¸ªå­—å…¸
    field_value = item.get('fieldName', 'default_value')
```

### 2. è¾“å‡ºæ•°æ®è®¾ç½®

```python
# å•ä¸ªè¾“å‡º
_result = {'key': 'value'}

# åœ¨å¾ªç¯ä¸­è¾“å‡ºï¼ˆæœ€åä¸€æ¬¡èµ‹å€¼æœ‰æ•ˆï¼‰
for item in _input.all():
    processed_data = do_something(item)
    _result = processed_data  # æ¯æ¬¡å¾ªç¯éƒ½è®¾ç½®è¾“å‡º
```

### 3. è®¿é—®å·¥ä½œæµå˜é‡

```python
# æ³¨æ„ï¼šåœ¨ Python Code Tool ä¸­ï¼Œå·¥ä½œæµå˜é‡è®¿é—®æœ‰é™
# ä¸»è¦é€šè¿‡è¾“å…¥æ•°æ®ä¼ é€’

# å¦‚æœéœ€è¦è®¿é—®ç¯å¢ƒå˜é‡
import os
api_key = os.environ.get('API_KEY', '')
```

## ğŸ” è°ƒè¯•æŠ€å·§

### 1. æ‰“å°è°ƒè¯•ä¿¡æ¯

```python
# n8n ä¼šæ•è· print è¾“å‡º
for item in _input.all():
    print(f"Processing item: {item}")
    print(f"Contract text length: {len(item.get('contractText', ''))}")
```

### 2. é”™è¯¯å¤„ç†

```python
for item in _input.all():
    try:
        contract_text = item.get('contractText', '')
        if not contract_text:
            _result = {'error': 'Contract text is empty'}
        else:
            result = process_contract(contract_text)
            _result = {'success': True, 'data': result}
    except Exception as e:
        _result = {'error': str(e)}
```

### 3. æ•°æ®éªŒè¯

```python
for item in _input.all():
    # éªŒè¯å¿…éœ€å­—æ®µ
    if 'contractText' not in item:
        _result = {'error': 'Missing contractText field'}
        break
    
    contract_text = item['contractText']
    # ç»§ç»­å¤„ç†...
```

## ğŸ“š å¸¸è§é”™è¯¯åŠè§£å†³æ–¹æ¡ˆ

### é”™è¯¯ 1: `SyntaxError: invalid syntax`
**åŸå› **: ä½¿ç”¨äº† `$` ç¬¦å·ï¼ˆJavaScript è¯­æ³•ï¼‰  
**è§£å†³**: æ”¹ç”¨ `_input`ï¼ˆä¸‹åˆ’çº¿å‰ç¼€ï¼‰

### é”™è¯¯ 2: `NameError: name '$input' is not defined`
**åŸå› **: åœ¨ Python ä¸­ä½¿ç”¨äº† JavaScript å˜é‡  
**è§£å†³**: ä½¿ç”¨ `_input.all()` æ›¿ä»£ `$input`

### é”™è¯¯ 3: `AttributeError: 'dict' object has no attribute 'json'`
**åŸå› **: å°è¯•ä½¿ç”¨ `.json` å±æ€§ï¼ˆJavaScript è¯­æ³•ï¼‰  
**è§£å†³**: ç›´æ¥ä½¿ç”¨ `item.get('field')`

### é”™è¯¯ 4: `return outside function`
**åŸå› **: åœ¨å…¨å±€ä½œç”¨åŸŸä½¿ç”¨ `return`  
**è§£å†³**: ä½¿ç”¨ `_result = ...` ä»£æ›¿ `return ...`

### é”™è¯¯ 5: `Wrong output type returned`
**åŸå› **: `_result` è¢«è®¾ç½®ä¸º JSON å­—ç¬¦ä¸²è€Œä¸æ˜¯å­—å…¸  
**è§£å†³**: å‡½æ•°ç›´æ¥è¿”å›å­—å…¸å¯¹è±¡ï¼Œä¸è¦ä½¿ç”¨ `json.dumps()`

## âœ… éªŒè¯æ¸…å•

ä½¿ç”¨ä¿®å¤åçš„ä»£ç å‰ï¼Œè¯·ç¡®è®¤ï¼š

- [ ] æ²¡æœ‰ä½¿ç”¨ `$` ç¬¦å·
- [ ] ä½¿ç”¨ `_input.all()` è·å–è¾“å…¥
- [ ] ä½¿ç”¨ `item.get()` è®¿é—®å­—æ®µ
- [ ] ä½¿ç”¨ `_result = result` è®¾ç½®è¾“å‡ºï¼ˆresult æ˜¯å­—å…¸å¯¹è±¡ï¼‰
- [ ] **å‡½æ•°è¿”å›å­—å…¸å¯¹è±¡ï¼Œä¸ä½¿ç”¨ `json.dumps()`**
- [ ] æ²¡æœ‰ä½¿ç”¨ `return` è¯­å¥ï¼ˆåœ¨å…¨å±€ä½œç”¨åŸŸï¼‰
- [ ] æ­£ç¡®ä½¿ç”¨ Python å¾ªç¯è¯­æ³•
- [ ] å­—æ®µåç§°ç”¨å­—ç¬¦ä¸²ï¼ˆå¦‚ `'contractText'`ï¼‰
- [ ] `_result` çš„å€¼æ˜¯ Python å­—å…¸ï¼Œä¸æ˜¯ JSON å­—ç¬¦ä¸²

## ğŸ‰ ç°åœ¨å¯ä»¥ä½¿ç”¨äº†ï¼

æ‰€æœ‰ Python æ–‡ä»¶å·²ä¿®å¤ï¼Œè¯­æ³•é”™è¯¯å·²è§£å†³ï¼š

1. âœ… `/home/magy/IASMind/n8n/scripts/contract_risk_assessment.py`
2. âœ… `/home/magy/IASMind/n8n/scripts/compliance_checker.py`
3. âœ… `/home/magy/IASMind/n8n/scripts/terms_extractor.py`
4. âœ… `/home/magy/IASMind/n8n/workflow/aviation-fuel-contract-review.json`

å¯ä»¥ç›´æ¥å¤åˆ¶è¿™äº›æ–‡ä»¶çš„å†…å®¹åˆ° n8n çš„ Code Tool èŠ‚ç‚¹ä¸­ä½¿ç”¨ï¼

---

**æœ€åæ›´æ–°**: 2025-10-30  
**ä¿®å¤å†…å®¹**: JavaScript è¯­æ³• â†’ Python è¯­æ³•  
**é€‚ç”¨ç‰ˆæœ¬**: n8n 1.116.2

