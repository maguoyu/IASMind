# n8n Python Code Tool 语法修复说明

## 🔴 问题说明

### 错误 1: `SyntaxError: invalid syntax`
**根本原因**: Python 代码中使用了 JavaScript 语法！

### 错误 2: `Wrong output type returned`
**根本原因**: 返回了 JSON 字符串而不是 Python 字典！

## ⚠️ 错误的代码（修复前）

```python
# ❌ 这是 JavaScript 语法，在 Python 中会报错！
contract_text = $input.first().json.get('contractText', '')
contract_amount = $input.first().json.get('contractAmount', 0)

result = assess_contract_risks(contract_text, contract_amount)
return {'json': {'riskAssessment': result}}
```

**问题点**:
1. `$input.first()` - 这是 JavaScript 语法，`$` 在 Python 中是非法字符
2. `.json.get()` - JavaScript 链式调用
3. `return {'json': {...}}` - JavaScript 的返回格式
4. `json.dumps()` - 返回 JSON 字符串而不是字典对象

## ✅ 正确的代码（修复后）

### 修复 1: 正确的输入访问语法

```python
# ✅ n8n Python Code Tool 的正确语法
for item in _input.all():
    contract_text = item.get('contractText', '')
    contract_amount = item.get('contractAmount', 0)
    
    result = assess_contract_risks(contract_text, contract_amount)
    _result = result  # 直接使用字典，不要 json.dumps()
```

**修复要点**:
1. `_input.all()` - 使用下划线前缀的 Python 对象（注意：是下划线，不是美元符号）
2. `for item in` - Python 标准的循环语法
3. `item.get()` - Python 字典的 get 方法
4. `_result = result` - 直接赋值字典对象，**不要转成 JSON 字符串**

### 修复 2: 正确的输出类型

```python
def assess_contract_risks(contract_text, contract_amount):
    risks = {
        "总体风险评分": 0,
        "价格风险": {"评分": 0, "说明": ""}
    }
    # ... 处理逻辑 ...
    
    # ❌ 错误：返回 JSON 字符串
    # return json.dumps(risks, ensure_ascii=False, indent=2)
    
    # ✅ 正确：直接返回字典
    return risks

# n8n 调用接口
for item in _input.all():
    result = assess_contract_risks(...)
    # ❌ 错误：包装成额外的字典
    # _result = {'riskAssessment': result}
    
    # ✅ 正确：直接使用返回的字典
    _result = result
```

## 📊 完整的语法对照表

| 功能 | ❌ JavaScript (n8n) | ✅ Python (n8n) |
|------|---------------------|-----------------|
| **获取第一个输入项** | `$input.first()` | `_input.all()[0]` 或循环 |
| **获取所有输入项** | `$input.all()` | `_input.all()` |
| **访问 JSON 数据** | `$json.body.field` | `item.get('field')` |
| **访问嵌套字段** | `$json.body.user.name` | `item.get('user', {}).get('name')` |
| **返回单个结果** | `return {'json': data}` | `_result = data` |
| **返回多个结果** | `return [{json: d1}, {json: d2}]` | 循环中多次赋值 `_result` |
| **环境变量** | `$env.API_KEY` | `os.environ.get('API_KEY')` |

## 📁 已修复的文件

### 1. contract_risk_assessment.py ✅
```python
# 修复前
contract_text = $input.first().json.get('contractText', '')

# 修复后
for item in _input.all():
    contract_text = item.get('contractText', '')
```

### 2. compliance_checker.py ✅
```python
# 修复前
contract_text = $input.first().json.get('contractText', '')

# 修复后
for item in _input.all():
    contract_text = item.get('contractText', '')
```

### 3. terms_extractor.py ✅
```python
# 修复前
contract_text = $input.first().json.get('contractText', '')

# 修复后
for item in _input.all():
    contract_text = item.get('contractText', '')
```

### 4. aviation-fuel-contract-review.json ✅
JSON 文件中嵌入的 Python 代码也已全部修复。

## 🎯 n8n Python Code Tool 核心要点

### 1. 输入数据访问

```python
# 获取所有输入项（返回列表）
all_items = _input.all()

# 循环处理每个输入项
for item in _input.all():
    # item 是一个字典
    field_value = item.get('fieldName', 'default_value')
```

### 2. 输出数据设置

```python
# 单个输出
_result = {'key': 'value'}

# 在循环中输出（最后一次赋值有效）
for item in _input.all():
    processed_data = do_something(item)
    _result = processed_data  # 每次循环都设置输出
```

### 3. 访问工作流变量

```python
# 注意：在 Python Code Tool 中，工作流变量访问有限
# 主要通过输入数据传递

# 如果需要访问环境变量
import os
api_key = os.environ.get('API_KEY', '')
```

## 🔍 调试技巧

### 1. 打印调试信息

```python
# n8n 会捕获 print 输出
for item in _input.all():
    print(f"Processing item: {item}")
    print(f"Contract text length: {len(item.get('contractText', ''))}")
```

### 2. 错误处理

```python
for item in _input.all():
    try:
        contract_text = item.get('contractText', '')
        if not contract_text:
            _result = {'error': 'Contract text is empty'}
        else:
            result = process_contract(contract_text)
            _result = {'success': True, 'data': result}
    except Exception as e:
        _result = {'error': str(e)}
```

### 3. 数据验证

```python
for item in _input.all():
    # 验证必需字段
    if 'contractText' not in item:
        _result = {'error': 'Missing contractText field'}
        break
    
    contract_text = item['contractText']
    # 继续处理...
```

## 📚 常见错误及解决方案

### 错误 1: `SyntaxError: invalid syntax`
**原因**: 使用了 `$` 符号（JavaScript 语法）  
**解决**: 改用 `_input`（下划线前缀）

### 错误 2: `NameError: name '$input' is not defined`
**原因**: 在 Python 中使用了 JavaScript 变量  
**解决**: 使用 `_input.all()` 替代 `$input`

### 错误 3: `AttributeError: 'dict' object has no attribute 'json'`
**原因**: 尝试使用 `.json` 属性（JavaScript 语法）  
**解决**: 直接使用 `item.get('field')`

### 错误 4: `return outside function`
**原因**: 在全局作用域使用 `return`  
**解决**: 使用 `_result = ...` 代替 `return ...`

### 错误 5: `Wrong output type returned`
**原因**: `_result` 被设置为 JSON 字符串而不是字典  
**解决**: 函数直接返回字典对象，不要使用 `json.dumps()`

## ✅ 验证清单

使用修复后的代码前，请确认：

- [ ] 没有使用 `$` 符号
- [ ] 使用 `_input.all()` 获取输入
- [ ] 使用 `item.get()` 访问字段
- [ ] 使用 `_result = result` 设置输出（result 是字典对象）
- [ ] **函数返回字典对象，不使用 `json.dumps()`**
- [ ] 没有使用 `return` 语句（在全局作用域）
- [ ] 正确使用 Python 循环语法
- [ ] 字段名称用字符串（如 `'contractText'`）
- [ ] `_result` 的值是 Python 字典，不是 JSON 字符串

## 🎉 现在可以使用了！

所有 Python 文件已修复，语法错误已解决：

1. ✅ `/home/magy/IASMind/n8n/scripts/contract_risk_assessment.py`
2. ✅ `/home/magy/IASMind/n8n/scripts/compliance_checker.py`
3. ✅ `/home/magy/IASMind/n8n/scripts/terms_extractor.py`
4. ✅ `/home/magy/IASMind/n8n/workflow/aviation-fuel-contract-review.json`

可以直接复制这些文件的内容到 n8n 的 Code Tool 节点中使用！

---

**最后更新**: 2025-10-30  
**修复内容**: JavaScript 语法 → Python 语法  
**适用版本**: n8n 1.116.2

