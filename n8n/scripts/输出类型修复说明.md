# n8n Python Code Tool 输出类型修复

## 🔴 错误：Wrong output type returned

### 完整错误信息
```
Wrong output type returned
The response property should be a string, but it is an undefined
```

### 根本原因
这个错误是因为 **AI Agent Tool 需要特定的输出格式**！

AI Agent 的 Tool 必须返回：
```python
_result = {
    "response": "字符串内容"  # 必须有 response 字段，且值必须是字符串
}
```

## 📊 快速对照

| 项目 | ❌ 错误做法 | ✅ 正确做法 |
|------|-----------|-----------|
| **函数返回值** | `return json.dumps(data)` | `return data` |
| **输出类型** | JSON 字符串 `"{...}"` | Python 字典 `{...}` |
| **_result 赋值** | `_result = {'key': json_string}` | `_result = dict_obj` |
| **需要 json 模块吗** | ❌ 不需要 `json.dumps()` | ✅ 只需要 `import json` 用于其他用途 |

## ⚠️ 错误示例

```python
import json

def assess_contract_risks(contract_text, contract_amount):
    risks = {
        "总体风险评分": 70,
        "价格风险": {"评分": 60, "说明": "中等风险"}
    }
    
    # ❌ 错误：转成 JSON 字符串
    return json.dumps(risks, ensure_ascii=False, indent=2)

# n8n 调用接口
for item in _input.all():
    result = assess_contract_risks(...)
    
    # ❌ 错误：result 现在是字符串，不是字典
    _result = {'riskAssessment': result}  # 嵌套错误！
```

**问题分析**:
1. `json.dumps()` 返回的是字符串：`"{\n  \"总体风险评分\": 70,\n  ...}"`
2. n8n 期望 `_result` 是字典对象，而不是字符串
3. 即使包装成 `{'riskAssessment': result}`，内层仍是字符串

## ✅ 正确示例（AI Agent Tool）

```python
import json  # 用于将结果转换为 JSON 字符串

def assess_contract_risks(contract_text, contract_amount):
    risks = {
        "总体风险评分": 70,
        "价格风险": {"评分": 60, "说明": "中等风险"}
    }
    
    # ✅ 函数返回字典对象
    return risks

# n8n AI Agent Tool 调用接口
for item in _input.all():
    result = assess_contract_risks(...)
    
    # ✅ 正确：包装成 {"response": "字符串"} 格式
    _result = {
        "response": json.dumps(result, ensure_ascii=False, indent=2)
    }
```

**为什么这样是对的**:
1. `risks` 是一个 Python 字典对象
2. 函数返回字典对象（不在函数内转换成字符串）
3. `_result` 是字典，包含 `response` 字段
4. `response` 的值是 JSON 字符串，AI 可以读取和理解
5. `ensure_ascii=False` 保留中文字符
6. `indent=2` 格式化输出，提高可读性

## 🔍 如何检查

### 检查 1: 函数返回值

```python
# ❌ 如果你看到这个
return json.dumps(data, ensure_ascii=False, indent=2)

# ✅ 改成这个
return data
```

### 检查 2: _result 赋值

```python
# ❌ 如果 result 已经是你需要的完整数据
_result = {'wrapperKey': result}

# ✅ 直接使用
_result = result
```

### 检查 3: 数据类型验证

```python
# 在开发时可以这样检查
result = assess_contract_risks(...)
print(f"Type: {type(result)}")  # 应该显示 <class 'dict'>

# ❌ 如果显示 <class 'str'>，说明用了 json.dumps()
# ✅ 如果显示 <class 'dict'>，正确！
```

## 📝 三个工具的修复（AI Agent Tool 专用格式）

### 1. 合同风险评估工具

```python
# 修复前（错误）
return json.dumps(risks, ensure_ascii=False, indent=2)  # 函数返回字符串 ❌
_result = {'riskAssessment': result}  # 缺少 response 字段 ❌

# 修复后（正确）
return risks  # 函数返回字典对象 ✅
_result = {
    "response": json.dumps(result, ensure_ascii=False, indent=2)  # 包装成 AI Agent 格式 ✅
}
```

### 2. 合规检查工具

```python
# 修复前（错误）
return json.dumps(compliance_report, ensure_ascii=False, indent=2)
_result = {'complianceReport': result}

# 修复后（正确）
return compliance_report  # 字典对象
_result = {
    "response": json.dumps(result, ensure_ascii=False, indent=2)
}
```

### 3. 条款提取工具

```python
# 修复前（错误）
return json.dumps(terms, ensure_ascii=False, indent=2)
_result = {'extractedTerms': result}

# 修复后（正确）
return terms  # 字典对象
_result = {
    "response": json.dumps(result, ensure_ascii=False, indent=2)
}
```

## 🎯 核心原则

### n8n AI Agent Tool 的输出规则（重要！）

1. **`_result` 必须是字典，包含 `response` 字段**
   ```python
   _result = {"response": "..."}
   ```

2. **`response` 的值必须是字符串**
   - 如果数据是结构化的（字典、列表），使用 `json.dumps()` 转换
   - 如果数据本身就是文本，直接使用字符串

3. **函数返回字典对象，在 n8n 接口处转换为字符串**

### AI Agent Tool vs 普通 Code 节点

| 节点类型 | 输出格式 | 示例 |
|---------|---------|------|
| **AI Agent Tool** | `{"response": "字符串"}` | `{"response": json.dumps(data)}` |
| **普通 Code 节点** | Python 对象 | `_result = data` |

### 什么时候使用 json.dumps()？

```python
# ✅ AI Agent Tool：必须使用
_result = {
    "response": json.dumps(data, ensure_ascii=False, indent=2)
}

# ✅ 调试输出
print(f"结果: {json.dumps(data, ensure_ascii=False)}")

# ❌ 不要在函数内使用（函数应返回字典对象）
def my_function():
    data = {"key": "value"}
    return json.dumps(data)  # ❌ 错误
```

## 🧪 测试方法

在 n8n Code Tool 中测试：

```python
# 添加调试信息
for item in _input.all():
    result = assess_contract_risks(...)
    
    # 调试：检查类型
    print(f"Result type: {type(result)}")
    print(f"Result: {result}")
    
    # 如果 type 显示 <class 'str'>，说明有问题
    # 如果 type 显示 <class 'dict'>，正确！
    
    _result = result
```

## ✅ 现在已修复

所有三个工具的 Python 代码已更新：

- ✅ `contract_risk_assessment.py` - 返回字典对象
- ✅ `compliance_checker.py` - 返回字典对象
- ✅ `terms_extractor.py` - 返回字典对象
- ✅ `aviation-fuel-contract-review.json` - JSON 文件中的代码已同步

## 🎉 总结

**记住这个简单规则**:

> **在 n8n Python Code Tool 中，`_result` 要的是 Python 对象，不是 JSON 字符串！**

```python
# ❌ 这会报错：Wrong output type returned
_result = json.dumps({"key": "value"})

# ✅ 这样才对
_result = {"key": "value"}
```

---

**最后更新**: 2025-10-30  
**修复问题**: Wrong output type returned  
**适用版本**: n8n 1.116.2

