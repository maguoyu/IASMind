# n8n Python Code Tool è¾“å‡ºç±»å‹ä¿®å¤

## ğŸ”´ é”™è¯¯ï¼šWrong output type returned

### å®Œæ•´é”™è¯¯ä¿¡æ¯
```
Wrong output type returned
The response property should be a string, but it is an undefined
```

### æ ¹æœ¬åŸå› 
è¿™ä¸ªé”™è¯¯æ˜¯å› ä¸º **AI Agent Tool éœ€è¦ç‰¹å®šçš„è¾“å‡ºæ ¼å¼**ï¼

AI Agent çš„ Tool å¿…é¡»è¿”å›ï¼š
```python
_result = {
    "response": "å­—ç¬¦ä¸²å†…å®¹"  # å¿…é¡»æœ‰ response å­—æ®µï¼Œä¸”å€¼å¿…é¡»æ˜¯å­—ç¬¦ä¸²
}
```

## ğŸ“Š å¿«é€Ÿå¯¹ç…§

| é¡¹ç›® | âŒ é”™è¯¯åšæ³• | âœ… æ­£ç¡®åšæ³• |
|------|-----------|-----------|
| **å‡½æ•°è¿”å›å€¼** | `return json.dumps(data)` | `return data` |
| **è¾“å‡ºç±»å‹** | JSON å­—ç¬¦ä¸² `"{...}"` | Python å­—å…¸ `{...}` |
| **_result èµ‹å€¼** | `_result = {'key': json_string}` | `_result = dict_obj` |
| **éœ€è¦ json æ¨¡å—å—** | âŒ ä¸éœ€è¦ `json.dumps()` | âœ… åªéœ€è¦ `import json` ç”¨äºå…¶ä»–ç”¨é€” |

## âš ï¸ é”™è¯¯ç¤ºä¾‹

```python
import json

def assess_contract_risks(contract_text, contract_amount):
    risks = {
        "æ€»ä½“é£é™©è¯„åˆ†": 70,
        "ä»·æ ¼é£é™©": {"è¯„åˆ†": 60, "è¯´æ˜": "ä¸­ç­‰é£é™©"}
    }
    
    # âŒ é”™è¯¯ï¼šè½¬æˆ JSON å­—ç¬¦ä¸²
    return json.dumps(risks, ensure_ascii=False, indent=2)

# n8n è°ƒç”¨æ¥å£
for item in _input.all():
    result = assess_contract_risks(...)
    
    # âŒ é”™è¯¯ï¼šresult ç°åœ¨æ˜¯å­—ç¬¦ä¸²ï¼Œä¸æ˜¯å­—å…¸
    _result = {'riskAssessment': result}  # åµŒå¥—é”™è¯¯ï¼
```

**é—®é¢˜åˆ†æ**:
1. `json.dumps()` è¿”å›çš„æ˜¯å­—ç¬¦ä¸²ï¼š`"{\n  \"æ€»ä½“é£é™©è¯„åˆ†\": 70,\n  ...}"`
2. n8n æœŸæœ› `_result` æ˜¯å­—å…¸å¯¹è±¡ï¼Œè€Œä¸æ˜¯å­—ç¬¦ä¸²
3. å³ä½¿åŒ…è£…æˆ `{'riskAssessment': result}`ï¼Œå†…å±‚ä»æ˜¯å­—ç¬¦ä¸²

## âœ… æ­£ç¡®ç¤ºä¾‹ï¼ˆAI Agent Toolï¼‰

```python
import json  # ç”¨äºå°†ç»“æœè½¬æ¢ä¸º JSON å­—ç¬¦ä¸²

def assess_contract_risks(contract_text, contract_amount):
    risks = {
        "æ€»ä½“é£é™©è¯„åˆ†": 70,
        "ä»·æ ¼é£é™©": {"è¯„åˆ†": 60, "è¯´æ˜": "ä¸­ç­‰é£é™©"}
    }
    
    # âœ… å‡½æ•°è¿”å›å­—å…¸å¯¹è±¡
    return risks

# n8n AI Agent Tool è°ƒç”¨æ¥å£
for item in _input.all():
    result = assess_contract_risks(...)
    
    # âœ… æ­£ç¡®ï¼šåŒ…è£…æˆ {"response": "å­—ç¬¦ä¸²"} æ ¼å¼
    _result = {
        "response": json.dumps(result, ensure_ascii=False, indent=2)
    }
```

**ä¸ºä»€ä¹ˆè¿™æ ·æ˜¯å¯¹çš„**:
1. `risks` æ˜¯ä¸€ä¸ª Python å­—å…¸å¯¹è±¡
2. å‡½æ•°è¿”å›å­—å…¸å¯¹è±¡ï¼ˆä¸åœ¨å‡½æ•°å†…è½¬æ¢æˆå­—ç¬¦ä¸²ï¼‰
3. `_result` æ˜¯å­—å…¸ï¼ŒåŒ…å« `response` å­—æ®µ
4. `response` çš„å€¼æ˜¯ JSON å­—ç¬¦ä¸²ï¼ŒAI å¯ä»¥è¯»å–å’Œç†è§£
5. `ensure_ascii=False` ä¿ç•™ä¸­æ–‡å­—ç¬¦
6. `indent=2` æ ¼å¼åŒ–è¾“å‡ºï¼Œæé«˜å¯è¯»æ€§

## ğŸ” å¦‚ä½•æ£€æŸ¥

### æ£€æŸ¥ 1: å‡½æ•°è¿”å›å€¼

```python
# âŒ å¦‚æœä½ çœ‹åˆ°è¿™ä¸ª
return json.dumps(data, ensure_ascii=False, indent=2)

# âœ… æ”¹æˆè¿™ä¸ª
return data
```

### æ£€æŸ¥ 2: _result èµ‹å€¼

```python
# âŒ å¦‚æœ result å·²ç»æ˜¯ä½ éœ€è¦çš„å®Œæ•´æ•°æ®
_result = {'wrapperKey': result}

# âœ… ç›´æ¥ä½¿ç”¨
_result = result
```

### æ£€æŸ¥ 3: æ•°æ®ç±»å‹éªŒè¯

```python
# åœ¨å¼€å‘æ—¶å¯ä»¥è¿™æ ·æ£€æŸ¥
result = assess_contract_risks(...)
print(f"Type: {type(result)}")  # åº”è¯¥æ˜¾ç¤º <class 'dict'>

# âŒ å¦‚æœæ˜¾ç¤º <class 'str'>ï¼Œè¯´æ˜ç”¨äº† json.dumps()
# âœ… å¦‚æœæ˜¾ç¤º <class 'dict'>ï¼Œæ­£ç¡®ï¼
```

## ğŸ“ ä¸‰ä¸ªå·¥å…·çš„ä¿®å¤ï¼ˆAI Agent Tool ä¸“ç”¨æ ¼å¼ï¼‰

### 1. åˆåŒé£é™©è¯„ä¼°å·¥å…·

```python
# ä¿®å¤å‰ï¼ˆé”™è¯¯ï¼‰
return json.dumps(risks, ensure_ascii=False, indent=2)  # å‡½æ•°è¿”å›å­—ç¬¦ä¸² âŒ
_result = {'riskAssessment': result}  # ç¼ºå°‘ response å­—æ®µ âŒ

# ä¿®å¤åï¼ˆæ­£ç¡®ï¼‰
return risks  # å‡½æ•°è¿”å›å­—å…¸å¯¹è±¡ âœ…
_result = {
    "response": json.dumps(result, ensure_ascii=False, indent=2)  # åŒ…è£…æˆ AI Agent æ ¼å¼ âœ…
}
```

### 2. åˆè§„æ£€æŸ¥å·¥å…·

```python
# ä¿®å¤å‰ï¼ˆé”™è¯¯ï¼‰
return json.dumps(compliance_report, ensure_ascii=False, indent=2)
_result = {'complianceReport': result}

# ä¿®å¤åï¼ˆæ­£ç¡®ï¼‰
return compliance_report  # å­—å…¸å¯¹è±¡
_result = {
    "response": json.dumps(result, ensure_ascii=False, indent=2)
}
```

### 3. æ¡æ¬¾æå–å·¥å…·

```python
# ä¿®å¤å‰ï¼ˆé”™è¯¯ï¼‰
return json.dumps(terms, ensure_ascii=False, indent=2)
_result = {'extractedTerms': result}

# ä¿®å¤åï¼ˆæ­£ç¡®ï¼‰
return terms  # å­—å…¸å¯¹è±¡
_result = {
    "response": json.dumps(result, ensure_ascii=False, indent=2)
}
```

## ğŸ¯ æ ¸å¿ƒåŸåˆ™

### n8n AI Agent Tool çš„è¾“å‡ºè§„åˆ™ï¼ˆé‡è¦ï¼ï¼‰

1. **`_result` å¿…é¡»æ˜¯å­—å…¸ï¼ŒåŒ…å« `response` å­—æ®µ**
   ```python
   _result = {"response": "..."}
   ```

2. **`response` çš„å€¼å¿…é¡»æ˜¯å­—ç¬¦ä¸²**
   - å¦‚æœæ•°æ®æ˜¯ç»“æ„åŒ–çš„ï¼ˆå­—å…¸ã€åˆ—è¡¨ï¼‰ï¼Œä½¿ç”¨ `json.dumps()` è½¬æ¢
   - å¦‚æœæ•°æ®æœ¬èº«å°±æ˜¯æ–‡æœ¬ï¼Œç›´æ¥ä½¿ç”¨å­—ç¬¦ä¸²

3. **å‡½æ•°è¿”å›å­—å…¸å¯¹è±¡ï¼Œåœ¨ n8n æ¥å£å¤„è½¬æ¢ä¸ºå­—ç¬¦ä¸²**

### AI Agent Tool vs æ™®é€š Code èŠ‚ç‚¹

| èŠ‚ç‚¹ç±»å‹ | è¾“å‡ºæ ¼å¼ | ç¤ºä¾‹ |
|---------|---------|------|
| **AI Agent Tool** | `{"response": "å­—ç¬¦ä¸²"}` | `{"response": json.dumps(data)}` |
| **æ™®é€š Code èŠ‚ç‚¹** | Python å¯¹è±¡ | `_result = data` |

### ä»€ä¹ˆæ—¶å€™ä½¿ç”¨ json.dumps()ï¼Ÿ

```python
# âœ… AI Agent Toolï¼šå¿…é¡»ä½¿ç”¨
_result = {
    "response": json.dumps(data, ensure_ascii=False, indent=2)
}

# âœ… è°ƒè¯•è¾“å‡º
print(f"ç»“æœ: {json.dumps(data, ensure_ascii=False)}")

# âŒ ä¸è¦åœ¨å‡½æ•°å†…ä½¿ç”¨ï¼ˆå‡½æ•°åº”è¿”å›å­—å…¸å¯¹è±¡ï¼‰
def my_function():
    data = {"key": "value"}
    return json.dumps(data)  # âŒ é”™è¯¯
```

## ğŸ§ª æµ‹è¯•æ–¹æ³•

åœ¨ n8n Code Tool ä¸­æµ‹è¯•ï¼š

```python
# æ·»åŠ è°ƒè¯•ä¿¡æ¯
for item in _input.all():
    result = assess_contract_risks(...)
    
    # è°ƒè¯•ï¼šæ£€æŸ¥ç±»å‹
    print(f"Result type: {type(result)}")
    print(f"Result: {result}")
    
    # å¦‚æœ type æ˜¾ç¤º <class 'str'>ï¼Œè¯´æ˜æœ‰é—®é¢˜
    # å¦‚æœ type æ˜¾ç¤º <class 'dict'>ï¼Œæ­£ç¡®ï¼
    
    _result = result
```

## âœ… ç°åœ¨å·²ä¿®å¤

æ‰€æœ‰ä¸‰ä¸ªå·¥å…·çš„ Python ä»£ç å·²æ›´æ–°ï¼š

- âœ… `contract_risk_assessment.py` - è¿”å›å­—å…¸å¯¹è±¡
- âœ… `compliance_checker.py` - è¿”å›å­—å…¸å¯¹è±¡
- âœ… `terms_extractor.py` - è¿”å›å­—å…¸å¯¹è±¡
- âœ… `aviation-fuel-contract-review.json` - JSON æ–‡ä»¶ä¸­çš„ä»£ç å·²åŒæ­¥

## ğŸ‰ æ€»ç»“

**è®°ä½è¿™ä¸ªç®€å•è§„åˆ™**:

> **åœ¨ n8n Python Code Tool ä¸­ï¼Œ`_result` è¦çš„æ˜¯ Python å¯¹è±¡ï¼Œä¸æ˜¯ JSON å­—ç¬¦ä¸²ï¼**

```python
# âŒ è¿™ä¼šæŠ¥é”™ï¼šWrong output type returned
_result = json.dumps({"key": "value"})

# âœ… è¿™æ ·æ‰å¯¹
_result = {"key": "value"}
```

---

**æœ€åæ›´æ–°**: 2025-10-30  
**ä¿®å¤é—®é¢˜**: Wrong output type returned  
**é€‚ç”¨ç‰ˆæœ¬**: n8n 1.116.2

