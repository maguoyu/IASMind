# å¤§æ¨¡å‹æ¥å£è¶…æ—¶ä¼˜åŒ–æ–¹æ¡ˆ

## ğŸ”´ é—®é¢˜åˆ†æ

å½“åˆåŒæ–‡æœ¬è¿‡é•¿æ—¶ï¼Œä¼šå¯¼è‡´ï¼š
1. **è¾“å…¥ Token è¿‡å¤š** - åˆåŒæ–‡æœ¬ + System Prompt + å·¥å…·å®šä¹‰
2. **å¤„ç†æ—¶é—´è¿‡é•¿** - å¤§æ¨¡å‹éœ€è¦æ›´å¤šæ—¶é—´åˆ†æ
3. **æ¥å£è¶…æ—¶** - è¶…è¿‡ n8n æˆ– OpenAI çš„è¶…æ—¶é™åˆ¶

## ğŸ’¡ è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1: ä¼˜åŒ–å·¥å…·è¿”å›æ•°æ®ï¼ˆå‡å°‘è¾“å‡º Tokenï¼‰âœ… æ¨è

å½“å‰å·¥å…·è¿”å›çš„æ˜¯å®Œæ•´çš„ JSON å¯¹è±¡ï¼Œå¯ä»¥æ”¹ä¸ºè¿”å›**ç²¾ç®€çš„æ–‡å­—æè¿°**ã€‚

#### ä¿®æ”¹å‰ï¼ˆè¿”å›è¯¦ç»† JSONï¼‰
```python
result = {
    "æ€»ä½“é£é™©è¯„åˆ†": 70,
    "ä»·æ ¼é£é™©": {"è¯„åˆ†": 60, "è¯´æ˜": "ä»·æ ¼æ¡æ¬¾é£é™©ç­‰çº§ï¼šä¸­"},
    "ä¾›åº”é£é™©": {"è¯„åˆ†": 50, "è¯´æ˜": "..."},
    # ... æ›´å¤šè¯¦ç»†ä¿¡æ¯
}
return json.dumps(result, ensure_ascii=False, indent=2)
```

#### ä¿®æ”¹åï¼ˆè¿”å›ç²¾ç®€æ–‡å­—ï¼‰
```python
result = assess_contract_risks(contract_text, contract_amount)

# ç”Ÿæˆç²¾ç®€çš„æ–‡å­—æ‘˜è¦
summary = f"""ã€é£é™©è¯„ä¼°ç»“æœã€‘
æ€»ä½“é£é™©ï¼š{result['æ€»ä½“é£é™©è¯„åˆ†']}åˆ†
- ä»·æ ¼é£é™©ï¼š{result['ä»·æ ¼é£é™©']['è¯„åˆ†']}åˆ†
- ä¾›åº”é£é™©ï¼š{result['ä¾›åº”é£é™©']['è¯„åˆ†']}åˆ†
- è´¨é‡é£é™©ï¼š{result['è´¨é‡é£é™©']['è¯„åˆ†']}åˆ†
- æ³•å¾‹é£é™©ï¼š{result['æ³•å¾‹é£é™©']['è¯„åˆ†']}åˆ†
- è´¢åŠ¡é£é™©ï¼š{result['è´¢åŠ¡é£é™©']['è¯„åˆ†']}åˆ†
"""

return summary.strip()
```

**ä¼˜ç‚¹**ï¼š
- å‡å°‘ 70% çš„è¾“å‡º Token
- AI æ›´å®¹æ˜“ç†è§£å’Œæ€»ç»“
- å“åº”é€Ÿåº¦æ›´å¿«

### æ–¹æ¡ˆ 2: åˆåŒæ–‡æœ¬é¢„å¤„ç†ï¼ˆå‡å°‘è¾“å…¥ Tokenï¼‰âœ… æ¨è

åœ¨ "æå–åˆåŒæ•°æ®" (Set) èŠ‚ç‚¹ä¸­æ·»åŠ æ–‡æœ¬ç²¾ç®€é€»è¾‘ã€‚

```javascript
// åœ¨ Set èŠ‚ç‚¹çš„ chatInput å­—æ®µä¸­
={{
  const contractText = $json.body.contractText || $json.contractText || '';
  const contractId = $json.body.contractId || $json.contractId || 'æœªæä¾›';
  const supplierName = $json.body.supplierName || $json.supplierName || 'æœªæä¾›';
  const contractAmount = $json.body.contractAmount || $json.contractAmount || 0;
  
  // æ–‡æœ¬é•¿åº¦é™åˆ¶ï¼ˆä¾‹å¦‚æœ€å¤š 2000 å­—ç¬¦ï¼‰
  const maxLength = 2000;
  const trimmedText = contractText.length > maxLength 
    ? contractText.substring(0, maxLength) + '...(æ–‡æœ¬å·²æˆªæ–­)' 
    : contractText;
  
  return `è¯·å®¡æŸ¥ä»¥ä¸‹èˆªæ²¹é‡‡è´­åˆåŒï¼š

åˆåŒç¼–å·ï¼š${contractId}
ä¾›åº”å•†ï¼š${supplierName}
åˆåŒé‡‘é¢ï¼š${contractAmount}å…ƒ

åˆåŒæ‘˜è¦ï¼š
${trimmedText}`;
}}
```

### æ–¹æ¡ˆ 3: å¢åŠ è¶…æ—¶æ—¶é—´è®¾ç½®

#### åœ¨ OpenAI Chat Model èŠ‚ç‚¹ä¸­
```json
{
  "parameters": {
    "options": {
      "timeout": 120000  // 120ç§’ï¼ˆé»˜è®¤æ˜¯ 60ç§’ï¼‰
    }
  }
}
```

#### åœ¨ AI Agent èŠ‚ç‚¹ä¸­
```json
{
  "parameters": {
    "options": {
      "timeout": 180000  // 180ç§’
    }
  }
}
```

### æ–¹æ¡ˆ 4: ä¼˜åŒ– System Messageï¼ˆå‡å°‘æç¤ºè¯é•¿åº¦ï¼‰

#### å½“å‰ System Messageï¼ˆè¾ƒé•¿ï¼‰
```
# èˆªæ²¹é‡‡è´­åˆåŒæ™ºèƒ½å®¡æŸ¥ç³»ç»Ÿ

ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„èˆªç©ºç‡ƒæ²¹é‡‡è´­åˆåŒå®¡æŸ¥ä¸“å®¶...
ï¼ˆå¾ˆé•¿çš„æè¿°ï¼‰
```

#### ä¼˜åŒ–åï¼ˆç²¾ç®€ç‰ˆï¼‰
```
ä½ æ˜¯èˆªæ²¹é‡‡è´­åˆåŒå®¡æŸ¥ä¸“å®¶ã€‚ä½¿ç”¨ä»¥ä¸‹å·¥å…·åˆ†æåˆåŒï¼š

**å¯ç”¨å·¥å…·**ï¼š
1. ContractRiskAssessment - è¯„ä¼°é£é™©ï¼ˆä»·æ ¼ã€ä¾›åº”ã€è´¨é‡ã€æ³•å¾‹ã€è´¢åŠ¡ï¼‰
2. ComplianceChecker - æ£€æŸ¥åˆè§„æ€§ï¼ˆæ°‘èˆªæ³•è§„ã€å®‰å…¨ã€ç¯ä¿ï¼‰
3. TermsExtractor - æå–å…³é”®æ¡æ¬¾

**å®¡æŸ¥æµç¨‹**ï¼š
1. æå–å…³é”®æ¡æ¬¾
2. è¯„ä¼°é£é™©
3. æ£€æŸ¥åˆè§„æ€§
4. æä¾›å®¡æŸ¥ç»“è®ºå’Œå»ºè®®

è¯·ç®€æ´ä¸“ä¸šåœ°å›ç­”ï¼Œé‡ç‚¹çªå‡ºé£é™©å’Œé—®é¢˜ã€‚
```

### æ–¹æ¡ˆ 5: ä½¿ç”¨æ›´å¿«çš„æ¨¡å‹

```json
{
  "parameters": {
    "model": {
      "value": "gpt-4o-mini"  // æ¯” gpt-4o å¿« 3-5 å€ï¼Œä¾¿å®œ 15 å€
    }
  }
}
```

**æ¨¡å‹å¯¹æ¯”**ï¼š
| æ¨¡å‹ | é€Ÿåº¦ | æˆæœ¬ | é€‚ç”¨åœºæ™¯ |
|------|------|------|---------|
| gpt-4o | æ…¢ | é«˜ | å¤æ‚åˆ†æ |
| gpt-4o-mini | å¿« | ä½ | æ ‡å‡†å®¡æŸ¥ âœ… æ¨è |
| gpt-3.5-turbo | å¾ˆå¿« | å¾ˆä½ | ç®€å•å®¡æŸ¥ |

### æ–¹æ¡ˆ 6: åˆ†æ®µå¤„ç†é•¿æ–‡æœ¬

å¦‚æœåˆåŒç‰¹åˆ«é•¿ï¼ˆå¦‚ > 5000 å­—ï¼‰ï¼Œå¯ä»¥åˆ†æ®µå¤„ç†ï¼š

```javascript
// åœ¨ Code èŠ‚ç‚¹ä¸­åˆ†æ®µå¤„ç†
const contractText = $input.first().json.contractText;
const chunkSize = 2000;
const chunks = [];

for (let i = 0; i < contractText.length; i += chunkSize) {
  chunks.push(contractText.substring(i, i + chunkSize));
}

// å¯¹æ¯æ®µåˆ†åˆ«è°ƒç”¨å·¥å…·
const results = [];
for (const chunk of chunks) {
  // è°ƒç”¨å·¥å…·å¤„ç†æ¯ä¸€æ®µ
  // æ”¶é›†ç»“æœ
}

// åˆå¹¶ç»“æœ
return { json: { processedChunks: results } };
```

### æ–¹æ¡ˆ 7: ä½¿ç”¨æµå¼è¾“å‡ºï¼ˆSSEï¼‰

å¯ç”¨æµå¼è¾“å‡ºå¯ä»¥è®©ç”¨æˆ·æ›´å¿«çœ‹åˆ°å“åº”ï¼š

```json
{
  "parameters": {
    "options": {
      "streamUsage": true
    }
  }
}
```

åœ¨ "Respond to Webhook" èŠ‚ç‚¹ä¸­é…ç½® SSEï¼š
```json
{
  "parameters": {
    "options": {
      "responseMode": "stream"
    }
  }
}
```

## ğŸ“‹ æ¨èçš„ç»¼åˆä¼˜åŒ–æ–¹æ¡ˆ

### ç¬¬ä¸€æ­¥ï¼šä¼˜åŒ–å·¥å…·è¾“å‡ºï¼ˆç«‹å³ç”Ÿæ•ˆï¼‰

ä¿®æ”¹ä¸‰ä¸ªå·¥å…·çš„è¿”å›æ ¼å¼ä¸ºç²¾ç®€æ–‡å­—ï¼š

**é£é™©è¯„ä¼°å·¥å…·**ï¼š
```python
result = assess_contract_risks(contract_text, contract_amount)

summary = f"""é£é™©è¯„ä¼°ï¼šæ€»åˆ†{result['æ€»ä½“é£é™©è¯„åˆ†']}åˆ†
ä»·æ ¼{result['ä»·æ ¼é£é™©']['è¯„åˆ†']}åˆ†ã€ä¾›åº”{result['ä¾›åº”é£é™©']['è¯„åˆ†']}åˆ†ã€è´¨é‡{result['è´¨é‡é£é™©']['è¯„åˆ†']}åˆ†ã€æ³•å¾‹{result['æ³•å¾‹é£é™©']['è¯„åˆ†']}åˆ†ã€è´¢åŠ¡{result['è´¢åŠ¡é£é™©']['è¯„åˆ†']}åˆ†"""

return summary
```

**åˆè§„æ£€æŸ¥å·¥å…·**ï¼š
```python
result = check_compliance(contract_text)

åˆè§„é¡¹ = 'ã€'.join(result['åˆè§„é¡¹'][:3])  # åªåˆ—å‰3é¡¹
ä¸åˆè§„é¡¹ = 'ã€'.join(result['ä¸åˆè§„é¡¹'])

summary = f"""åˆè§„æ£€æŸ¥ï¼š{result['æ€»ä½“åˆè§„æ€§']}
âœ“ {åˆè§„é¡¹}
âœ— {ä¸åˆè§„é¡¹}"""

return summary
```

**æ¡æ¬¾æå–å·¥å…·**ï¼š
```python
result = extract_contract_terms(contract_text)

summary = f"""å…³é”®æ¡æ¬¾ï¼š
ä»·æ ¼ï¼š{result.get('å•†åŠ¡æ¡æ¬¾', {}).get('å•ä»·', 'æœªæå–')}
æ•°é‡ï¼š{result.get('å•†åŠ¡æ¡æ¬¾', {}).get('é‡‡è´­æ•°é‡', 'æœªæå–')}
è´¨é‡æ ‡å‡†ï¼š{result.get('è´¨é‡æ¡æ¬¾', {}).get('è´¨é‡æ ‡å‡†', 'æœªæå–')}"""

return summary
```

### ç¬¬äºŒæ­¥ï¼šç²¾ç®€ System Message

å°†å½“å‰çš„é•¿æç¤ºè¯å‹ç¼©åˆ° 200 å­—ä»¥å†…ã€‚

### ç¬¬ä¸‰æ­¥ï¼šå¢åŠ è¶…æ—¶è®¾ç½®

åœ¨ OpenAI Chat Model èŠ‚ç‚¹æ·»åŠ ï¼š
```json
{
  "options": {
    "timeout": 120000
  }
}
```

### ç¬¬å››æ­¥ï¼šåˆ‡æ¢åˆ°æ›´å¿«çš„æ¨¡å‹

ä½¿ç”¨ `gpt-4o-mini` æ›¿ä»£ `gpt-4o`ã€‚

## ğŸ”§ å…·ä½“å®æ–½æ­¥éª¤

### 1. ç«‹å³ä¼˜åŒ–ï¼ˆ5åˆ†é’Ÿï¼‰

ä¿®æ”¹ `aviation-fuel-contract-review.json` ä¸­çš„ä¸‰ä¸ªå·¥å…·ä»£ç ï¼Œå°†è¿”å›å€¼ä» JSON æ”¹ä¸ºç²¾ç®€æ–‡å­—ã€‚

### 2. ä¸­æœŸä¼˜åŒ–ï¼ˆ10åˆ†é’Ÿï¼‰

- ç²¾ç®€ System Message
- æ·»åŠ è¶…æ—¶é…ç½®
- è€ƒè™‘åˆ‡æ¢æ¨¡å‹

### 3. é•¿æœŸä¼˜åŒ–ï¼ˆéœ€è¦æ—¶ï¼‰

- å®ç°æ–‡æœ¬åˆ†æ®µå¤„ç†
- æ·»åŠ ç¼“å­˜æœºåˆ¶
- ä½¿ç”¨ SSE æµå¼è¾“å‡º

## ğŸ“Š é¢„æœŸæ•ˆæœ

| ä¼˜åŒ–é¡¹ | Token å‡å°‘ | é€Ÿåº¦æå‡ | æˆæœ¬é™ä½ |
|--------|-----------|---------|---------|
| ç²¾ç®€å·¥å…·è¾“å‡º | 60-70% | 30-40% | 30-40% |
| ç²¾ç®€ System Message | 20-30% | 10-15% | 10-15% |
| ä½¿ç”¨ gpt-4o-mini | - | 300% | 90% |
| **ç»¼åˆä¼˜åŒ–** | **70-80%** | **400%** | **95%** |

## âœ… å¿«é€Ÿå®æ–½æ¸…å•

- [ ] ä¿®æ”¹ä¸‰ä¸ªå·¥å…·è¿”å›ç²¾ç®€æ–‡å­—æ‘˜è¦
- [ ] ç²¾ç®€ System Message åˆ° 200 å­—ä»¥å†…
- [ ] æ·»åŠ  timeout é…ç½®ï¼ˆ120ç§’ï¼‰
- [ ] åˆ‡æ¢æ¨¡å‹åˆ° gpt-4o-mini
- [ ] åœ¨ Set èŠ‚ç‚¹ä¸­é™åˆ¶åˆåŒæ–‡æœ¬é•¿åº¦ï¼ˆ2000å­—ç¬¦ï¼‰
- [ ] æµ‹è¯•ä¼˜åŒ–æ•ˆæœ

## ğŸ¯ æœ€ç®€å•çš„ç«‹å³æ–¹æ¡ˆ

å¦‚æœç°åœ¨å°±è¦è§£å†³ï¼Œåªéœ€åšè¿™ä¸€ä»¶äº‹ï¼š

**å°†æ¨¡å‹ä» `gpt-4o` æ”¹ä¸º `gpt-4o-mini`ï¼Œå¹¶å¢åŠ è¶…æ—¶æ—¶é—´åˆ° 120 ç§’ã€‚**

è¿™æ ·å¯ä»¥ç«‹å³æå‡ 3-5 å€é€Ÿåº¦ï¼Œé™ä½ 90% æˆæœ¬ï¼Œè§£å†³è¶…æ—¶é—®é¢˜ã€‚

---

**å»ºè®®**: å…ˆä½¿ç”¨ gpt-4o-mini + å¢åŠ è¶…æ—¶çš„ç®€å•æ–¹æ¡ˆï¼Œå¦‚æœè¿˜æœ‰é—®é¢˜ï¼Œå†é€æ­¥åº”ç”¨å…¶ä»–ä¼˜åŒ–æªæ–½ã€‚


