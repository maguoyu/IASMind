# 大模型接口超时优化方案

## 🔴 问题分析

当合同文本过长时，会导致：
1. **输入 Token 过多** - 合同文本 + System Prompt + 工具定义
2. **处理时间过长** - 大模型需要更多时间分析
3. **接口超时** - 超过 n8n 或 OpenAI 的超时限制

## 💡 解决方案

### 方案 1: 优化工具返回数据（减少输出 Token）✅ 推荐

当前工具返回的是完整的 JSON 对象，可以改为返回**精简的文字描述**。

#### 修改前（返回详细 JSON）
```python
result = {
    "总体风险评分": 70,
    "价格风险": {"评分": 60, "说明": "价格条款风险等级：中"},
    "供应风险": {"评分": 50, "说明": "..."},
    # ... 更多详细信息
}
return json.dumps(result, ensure_ascii=False, indent=2)
```

#### 修改后（返回精简文字）
```python
result = assess_contract_risks(contract_text, contract_amount)

# 生成精简的文字摘要
summary = f"""【风险评估结果】
总体风险：{result['总体风险评分']}分
- 价格风险：{result['价格风险']['评分']}分
- 供应风险：{result['供应风险']['评分']}分
- 质量风险：{result['质量风险']['评分']}分
- 法律风险：{result['法律风险']['评分']}分
- 财务风险：{result['财务风险']['评分']}分
"""

return summary.strip()
```

**优点**：
- 减少 70% 的输出 Token
- AI 更容易理解和总结
- 响应速度更快

### 方案 2: 合同文本预处理（减少输入 Token）✅ 推荐

在 "提取合同数据" (Set) 节点中添加文本精简逻辑。

```javascript
// 在 Set 节点的 chatInput 字段中
={{
  const contractText = $json.body.contractText || $json.contractText || '';
  const contractId = $json.body.contractId || $json.contractId || '未提供';
  const supplierName = $json.body.supplierName || $json.supplierName || '未提供';
  const contractAmount = $json.body.contractAmount || $json.contractAmount || 0;
  
  // 文本长度限制（例如最多 2000 字符）
  const maxLength = 2000;
  const trimmedText = contractText.length > maxLength 
    ? contractText.substring(0, maxLength) + '...(文本已截断)' 
    : contractText;
  
  return `请审查以下航油采购合同：

合同编号：${contractId}
供应商：${supplierName}
合同金额：${contractAmount}元

合同摘要：
${trimmedText}`;
}}
```

### 方案 3: 增加超时时间设置

#### 在 OpenAI Chat Model 节点中
```json
{
  "parameters": {
    "options": {
      "timeout": 120000  // 120秒（默认是 60秒）
    }
  }
}
```

#### 在 AI Agent 节点中
```json
{
  "parameters": {
    "options": {
      "timeout": 180000  // 180秒
    }
  }
}
```

### 方案 4: 优化 System Message（减少提示词长度）

#### 当前 System Message（较长）
```
# 航油采购合同智能审查系统

你是一位专业的航空燃油采购合同审查专家...
（很长的描述）
```

#### 优化后（精简版）
```
你是航油采购合同审查专家。使用以下工具分析合同：

**可用工具**：
1. ContractRiskAssessment - 评估风险（价格、供应、质量、法律、财务）
2. ComplianceChecker - 检查合规性（民航法规、安全、环保）
3. TermsExtractor - 提取关键条款

**审查流程**：
1. 提取关键条款
2. 评估风险
3. 检查合规性
4. 提供审查结论和建议

请简洁专业地回答，重点突出风险和问题。
```

### 方案 5: 使用更快的模型

```json
{
  "parameters": {
    "model": {
      "value": "gpt-4o-mini"  // 比 gpt-4o 快 3-5 倍，便宜 15 倍
    }
  }
}
```

**模型对比**：
| 模型 | 速度 | 成本 | 适用场景 |
|------|------|------|---------|
| gpt-4o | 慢 | 高 | 复杂分析 |
| gpt-4o-mini | 快 | 低 | 标准审查 ✅ 推荐 |
| gpt-3.5-turbo | 很快 | 很低 | 简单审查 |

### 方案 6: 分段处理长文本

如果合同特别长（如 > 5000 字），可以分段处理：

```javascript
// 在 Code 节点中分段处理
const contractText = $input.first().json.contractText;
const chunkSize = 2000;
const chunks = [];

for (let i = 0; i < contractText.length; i += chunkSize) {
  chunks.push(contractText.substring(i, i + chunkSize));
}

// 对每段分别调用工具
const results = [];
for (const chunk of chunks) {
  // 调用工具处理每一段
  // 收集结果
}

// 合并结果
return { json: { processedChunks: results } };
```

### 方案 7: 使用流式输出（SSE）

启用流式输出可以让用户更快看到响应：

```json
{
  "parameters": {
    "options": {
      "streamUsage": true
    }
  }
}
```

在 "Respond to Webhook" 节点中配置 SSE：
```json
{
  "parameters": {
    "options": {
      "responseMode": "stream"
    }
  }
}
```

## 📋 推荐的综合优化方案

### 第一步：优化工具输出（立即生效）

修改三个工具的返回格式为精简文字：

**风险评估工具**：
```python
result = assess_contract_risks(contract_text, contract_amount)

summary = f"""风险评估：总分{result['总体风险评分']}分
价格{result['价格风险']['评分']}分、供应{result['供应风险']['评分']}分、质量{result['质量风险']['评分']}分、法律{result['法律风险']['评分']}分、财务{result['财务风险']['评分']}分"""

return summary
```

**合规检查工具**：
```python
result = check_compliance(contract_text)

合规项 = '、'.join(result['合规项'][:3])  # 只列前3项
不合规项 = '、'.join(result['不合规项'])

summary = f"""合规检查：{result['总体合规性']}
✓ {合规项}
✗ {不合规项}"""

return summary
```

**条款提取工具**：
```python
result = extract_contract_terms(contract_text)

summary = f"""关键条款：
价格：{result.get('商务条款', {}).get('单价', '未提取')}
数量：{result.get('商务条款', {}).get('采购数量', '未提取')}
质量标准：{result.get('质量条款', {}).get('质量标准', '未提取')}"""

return summary
```

### 第二步：精简 System Message

将当前的长提示词压缩到 200 字以内。

### 第三步：增加超时设置

在 OpenAI Chat Model 节点添加：
```json
{
  "options": {
    "timeout": 120000
  }
}
```

### 第四步：切换到更快的模型

使用 `gpt-4o-mini` 替代 `gpt-4o`。

## 🔧 具体实施步骤

### 1. 立即优化（5分钟）

修改 `aviation-fuel-contract-review.json` 中的三个工具代码，将返回值从 JSON 改为精简文字。

### 2. 中期优化（10分钟）

- 精简 System Message
- 添加超时配置
- 考虑切换模型

### 3. 长期优化（需要时）

- 实现文本分段处理
- 添加缓存机制
- 使用 SSE 流式输出

## 📊 预期效果

| 优化项 | Token 减少 | 速度提升 | 成本降低 |
|--------|-----------|---------|---------|
| 精简工具输出 | 60-70% | 30-40% | 30-40% |
| 精简 System Message | 20-30% | 10-15% | 10-15% |
| 使用 gpt-4o-mini | - | 300% | 90% |
| **综合优化** | **70-80%** | **400%** | **95%** |

## ✅ 快速实施清单

- [ ] 修改三个工具返回精简文字摘要
- [ ] 精简 System Message 到 200 字以内
- [ ] 添加 timeout 配置（120秒）
- [ ] 切换模型到 gpt-4o-mini
- [ ] 在 Set 节点中限制合同文本长度（2000字符）
- [ ] 测试优化效果

## 🎯 最简单的立即方案

如果现在就要解决，只需做这一件事：

**将模型从 `gpt-4o` 改为 `gpt-4o-mini`，并增加超时时间到 120 秒。**

这样可以立即提升 3-5 倍速度，降低 90% 成本，解决超时问题。

---

**建议**: 先使用 gpt-4o-mini + 增加超时的简单方案，如果还有问题，再逐步应用其他优化措施。


