# n8n 工作流导入代码丢失问题分析报告

## 📋 问题描述

将 `aviation-fuel-contract-review.json` 复制到 n8n 后，三个 Python 工具节点的代码丢失，只保留了 description 参数。

## 🔍 根本原因分析

### 原因1：AI Agent 节点缺少 `text` 参数 ⚠️

**问题节点：** AI合同审查专家

**原始配置（正确）：**
```json
{
  "parameters": {
    "text": "={{ $json.chatInput }}",  ← 必需参数
    "options": {
      "systemMessage": "..."
    }
  }
}
```

**从 n8n 导出的配置（错误）：**
```json
{
  "parameters": {
    "options": {  ← 缺少 text 参数
      "systemMessage": "..."
    }
  }
}
```

**影响：** 
- AI Agent 无法接收输入
- 工作流无法正常运行
- 导致关联的工具节点配置不完整

### 原因2：工具节点参数不正确 ❌

**问题节点：** Risk Assessment Tool、Compliance Checker、Terms Extractor

**原始配置（正确）：**
```json
{
  "parameters": {
    "name": "ContractRiskAssessment",  ← 工具标识符
    "description": "评估航油采购合同...",
    "pythonCode": "# 合同风险评估工具\nimport json..."  ← Python 代码
  },
  "type": "@n8n/n8n-nodes-langchain.toolCode",
  "typeVersion": 1.3
}
```

**从 n8n 导出的配置（错误）：**
```json
{
  "parameters": {
    "description": "评估航油采购合同..."  ← 只有描述，其他都丢失
  },
  "type": "@n8n/n8n-nodes-langchain.toolCode",
  "typeVersion": 1.3
}
```

**丢失的内容：**
- ❌ `name` 参数：工具标识符
- ❌ `pythonCode` 参数：Python 代码逻辑

## 🎯 为什么会丢失？

### 可能的原因

1. **导入方式不正确**
   - 直接复制 JSON 文本到 n8n → ❌ 错误
   - 使用 n8n "Import from File" 功能 → ✅ 正确

2. **n8n 版本兼容性问题**
   - JSON 格式可能与 n8n 1.116.2 版本不完全匹配
   - 某些参数名称在不同版本中可能不同

3. **节点类型不匹配**
   - 如果 n8n 实例中没有安装 `@n8n/n8n-nodes-langchain` 插件
   - 导入时可能无法正确解析节点配置

4. **浏览器复制粘贴问题**
   - 如果使用浏览器从文本编辑器复制 JSON
   - 可能丢失或损坏某些字符（特别是转义字符）

## ✅ 解决方案

### 方案1：使用正确的导入方法（推荐）

1. **不要**直接复制 JSON 内容
2. 在 n8n Web 界面中：
   ```
   菜单 → Import from File → 选择 JSON 文件 → Import
   ```
3. n8n 会正确解析所有参数

### 方案2：直接在 n8n UI 中配置工具

如果导入总是失败，手动配置：

1. **创建 Code Tool 节点**
2. **配置参数：**
   - Name: `ContractRiskAssessment`（必须是英文）
   - Description: 中文描述
   - Language: Python
   - 代码：从 `/home/magy/IASMind/n8n/scripts/*.py` 文件复制

3. **重复以上步骤**创建其他两个工具

### 方案3：检查 n8n 插件

确保已安装 LangChain 插件：

```bash
# 检查 n8n 已安装的插件
npm list @n8n/n8n-nodes-langchain

# 如果没有，需要安装
npm install @n8n/n8n-nodes-langchain
```

## 📊 完整的参数对照表

### AI Agent 节点

| 参数 | 必需 | 说明 | 示例值 |
|------|------|------|--------|
| `text` | ✅ | 输入文本 | `={{ $json.chatInput }}` |
| `options.systemMessage` | ✅ | 系统提示词 | "你是一位专业的..." |

### Tool Code 节点

| 参数 | 必需 | 说明 | 示例值 |
|------|------|------|--------|
| `name` | ✅ | 工具标识符（英文） | `ContractRiskAssessment` |
| `description` | ✅ | 工具描述（中文） | "评估航油采购合同..." |
| `pythonCode` | ✅ | Python 代码 | `"# 合同风险评估工具\nimport json..."` |

## 🔧 验证清单

导入后检查以下内容：

- [ ] AI Agent 节点有 `text` 参数
- [ ] AI Agent 节点有 `systemMessage`
- [ ] 三个工具节点都有 `name` 参数
- [ ] 三个工具节点都有 `pythonCode` 参数
- [ ] 三个工具节点的 `pythonCode` 不是空的
- [ ] 所有节点的连接（connections）正确
- [ ] Webhook 节点有正确的 path
- [ ] OpenAI 模型节点有正确的凭证

## 📝 最佳实践

### DO ✅

1. 使用 n8n UI 的 "Import from File" 功能
2. 导入后立即检查所有节点配置
3. 使用独立的 `.py` 文件维护代码
4. 定期导出工作流备份
5. 在测试环境先导入验证

### DON'T ❌

1. 不要直接复制粘贴 JSON 文本到 n8n
2. 不要手动编辑 JSON 中的转义字符
3. 不要跳过配置验证步骤
4. 不要在生产环境直接导入未测试的工作流
5. 不要忘记检查工具代码是否完整

## 🆘 故障排除步骤

如果导入后代码仍然丢失：

### 步骤1：验证文件完整性
```bash
# 检查 JSON 文件大小
ls -lh /home/magy/IASMind/n8n/workflow/aviation-fuel-contract-review.json

# 文件应该大于 30KB（包含完整代码）
# 如果太小，说明文件本身不完整
```

### 步骤2：检查 JSON 格式
```bash
# 验证 JSON 语法
cat aviation-fuel-contract-review.json | jq . > /dev/null && echo "JSON 格式正确" || echo "JSON 格式错误"
```

### 步骤3：搜索关键字
```bash
# 确认 pythonCode 参数存在
grep -o "pythonCode" aviation-fuel-contract-review.json | wc -l
# 应该返回 3（三个工具节点）

# 确认代码内容存在
grep -o "def assess_contract_risks" aviation-fuel-contract-review.json
# 应该能找到函数定义
```

### 步骤4：重新生成文件

如果文件损坏，使用原始的完整版本：
```bash
cp /home/magy/IASMind/n8n/workflow/aviation-fuel-contract-review.json \
   /home/magy/IASMind/n8n/workflow/copyjson.json
```

## 📚 相关资源

- [n8n 导入导出文档](https://docs.n8n.io/workflows/export/)
- [n8n Code Node 文档](https://docs.n8n.io/code/builtin/code-node/)
- [LangChain Tool Code 文档](https://docs.n8n.io/integrations/builtin/cluster-nodes/root-nodes/n8n-nodes-langchain.toolcode/)

## 💡 总结

**代码丢失的主要原因：**
1. 导入方式不正确（复制粘贴而非文件导入）
2. AI Agent 节点缺少 `text` 参数
3. Tool Code 节点缺少 `name` 和 `pythonCode` 参数

**解决方案：**
使用 n8n UI 的 "Import from File" 功能正确导入完整的 JSON 文件。

---

**文档创建时间：** 2025-10-30  
**适用 n8n 版本：** 1.116.2  
**工作流版本：** aviation-fuel-contract-review v1.0


