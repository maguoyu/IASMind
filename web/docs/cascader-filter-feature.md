# 销售预测样本数据级联筛选功能

## 功能概述

本次更新为销售预测模块的样本数据查询功能添加了级联筛选功能，将原来的单一地区筛选升级为三级级联筛选：地区 → 省级公司 → 地市级公司。

## 功能特性

### 1. 三级级联结构
- **第一级**：地区选择（华东、华南、华北）
- **第二级**：省级公司选择（如：华东航空燃料有限公司、江苏航空燃料公司等）
- **第三级**：地市级公司选择（如：上海浦东机场、南京禄口机场等）

### 2. 智能筛选逻辑
- 支持任意级别选择，选择上级后下级选项会自动更新
- 选择下级时上级选项会自动清空
- 保持向后兼容，原有的单一地区筛选仍然可用

### 3. 用户体验优化
- 级联选择器采用下拉弹窗形式，界面简洁美观
- 支持键盘导航和鼠标点击操作
- 显示当前选择路径，便于用户了解筛选状态

## 技术实现

### 1. 级联选择器组件
- **基础版本**：`web/src/components/ui/cascader.tsx`
- **专业版本**：`web/src/components/ui/cascader-pro.tsx` (推荐使用)
- 基于 Radix UI Popover 组件构建
- 支持自定义选项数据和回调函数

#### 专业版本特性
- 智能回显：根据选择层级智能显示路径，不挤占布局空间
- 清空功能：支持一键清空所有选择
- 响应式设计：弹出层自适应内容大小
- 视觉优化：更好的悬停效果和选中状态
- 性能优化：选择最终项后自动关闭弹窗

### 2. 数据结构
```typescript
interface CascaderOption {
  value: string;
  label: string;
  children?: CascaderOption[];
}
```

### 3. 筛选逻辑
- **样本数据查询**：`web/src/app/sales_forecast/main.tsx` (样本数据筛选)
- **预测结果查询**：`web/src/app/sales_forecast/main.tsx` (预测结果筛选)
- **样本管理器**：`web/src/app/sales_forecast/components/sample-manager.tsx`
- 实现了 `matchesCascaderFilter` 和 `matchesForecastCascaderFilter` 函数进行级联筛选

### 4. 数据映射
级联选择的值会映射到样本数据的以下字段：
- 地区：`item.region`
- 公司：`item.sampleFile` 或 `item.notes`
- 机场：`item.sampleFile` 或 `item.notes`

## 使用说明

### 1. 基本使用

#### 样本数据查询页面
1. 在样本数据查询页面，找到"地区"下拉框
2. 点击下拉框，选择第一级地区
3. 继续选择第二级省级公司
4. 可选择第三级地市级公司
5. 系统会自动根据选择过滤样本数据

#### 预测结果查询页面
1. 在预测结果查询页面，找到"地区"下拉框
2. 使用方式与样本数据查询相同
3. 支持按地区、公司、机场筛选预测结果
4. 与其他筛选条件（算法、时间范围）组合使用

### 2. 筛选规则
- 选择地区：只显示该地区的样本数据
- 选择公司：只显示该公司相关的样本数据
- 选择机场：只显示该机场相关的样本数据
- 清空选择：显示所有样本数据

### 3. 兼容性
- 原有的单一地区筛选功能仍然保留
- 如果使用级联筛选，则优先使用级联筛选结果
- 如果未使用级联筛选，则使用原有的地区筛选

## 数据配置

### 1. 级联选项配置
级联选择器的选项数据在以下文件中配置：
- 主文件：`cascaderOptions` 常量
- 样本管理器：`cascaderOptions` 常量

### 2. 添加新的地区/公司/机场
1. 在相应的 `cascaderOptions` 数组中添加新的选项
2. 确保数据结构符合 `CascaderOption` 接口
3. 更新筛选逻辑以支持新的数据映射

## 测试验证

### 1. 功能测试
- **基础版本测试**：`web/src/app/sales_forecast/test-cascader.tsx`
- **专业版本测试**：`web/src/app/sales_forecast/test-cascader-pro.tsx` (推荐)
- **预测结果筛选测试**：`web/src/app/sales_forecast/test-forecast-filter.tsx`
- 可以独立测试级联选择器的功能
- 验证选择逻辑和数据更新
- 测试回显效果和布局影响
- 测试预测结果查询的级联筛选功能

### 2. 集成测试
- 在样本数据查询页面测试级联筛选
- 验证筛选结果与预期一致
- 测试向后兼容性

## 注意事项

1. **数据一致性**：确保样本数据中的地区、公司、机场信息与级联选项保持一致
2. **性能考虑**：大量数据时级联筛选可能需要优化
3. **用户体验**：建议在筛选结果为空时给出友好提示
4. **数据更新**：当样本数据更新时，需要同步更新级联选项配置

## 搜索功能增强

### 1. 搜索按钮
- 预测结果查询页面新增搜索按钮
- 支持搜索状态显示（加载动画）
- 搜索按钮会触发筛选条件的应用

### 2. 重置功能
- 提供重置按钮一键清空所有筛选条件
- 包括级联选择器、任务名称、算法名称、时间范围
- 重置后恢复显示所有数据

### 3. 交互优化
- 搜索按钮在搜索过程中显示加载状态
- 重置按钮提供快速清空功能
- 按钮布局优化，搜索按钮占主要位置

## 表格功能增强

### 1. 地区公司列
- 预测结果查询页面表格新增"地区公司"列
- 显示具体的地区公司信息，如：华东、青岛、烟台、华南、华北、大连、济南、天津、上海、南京、杭州、广州等
- 使用 Badge 组件显示，样式为 outline 变体

### 2. 数据多样化
- 地区公司数据通过循环算法分配，确保数据的多样性
- 测试页面包含完整的地区公司数据示例
- 支持按地区公司进行筛选和查看

### 3. 表格布局优化
- 地区公司列位于算法列之后，执行时间列之前
- 保持表格的整体布局美观和信息层次清晰
- 响应式设计，在不同屏幕尺寸下都能良好显示

## 预测分析页面优化

### 1. 简化筛选条件
- 移除分析层级选择器（地区层级、合资公司层级、机场层级）
- 移除地区查询条件选择器
- 移除合资公司和机场的条件选择器
- 保留时间范围和多模型加权分析两个核心功能

### 2. 界面布局调整
- 筛选条件从4列网格改为4列网格（新增地区查询后）
- 移除显示选项的复选框控件
- 默认显示趋势图（showTrendChart 默认为 true）
- 简化用户操作流程，专注核心分析功能

### 3. 时间范围查询优化
- 将时间范围从下拉选择改为日期输入框
- 新增开始时间和结束时间两个独立的日期选择器
- 支持自定义时间范围，提供更灵活的分析维度
- 用户可以精确选择分析的时间区间

### 4. 地区查询功能增强
- 新增地区级联选择器，与样本数据查询功能保持一致
- 支持三级级联选择：地区 → 省级公司 → 地市级公司
- 使用 CascaderPro 组件，提供专业的级联选择体验
- 新增 analysisCascaderValue 状态管理地区选择
- 筛选条件包含：地区、开始时间、结束时间、多模型加权分析

### 5. 预测结果查询页面增强
- 保留原有的地区级联选择器
- 表格列结构保持不变，继续显示地区公司信息
- 搜索和重置功能正常运行



## 未来改进

1. **动态配置**：支持从后端动态加载级联选项
2. **搜索功能**：在级联选择器中添加搜索功能
3. **多选支持**：支持多选模式
4. **数据统计**：显示各级别的数据统计信息
5. **导出功能**：支持按级联筛选结果导出数据
6. **实时搜索**：支持输入时实时筛选，无需点击搜索按钮 